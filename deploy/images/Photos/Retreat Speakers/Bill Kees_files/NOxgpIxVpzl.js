/*1349106339,178142511*/

if (window.CavalryLogger) { CavalryLogger.start_js(["1ud7Z"]); }

__d("LiveListenNux",["Arbiter","HoverFlyout","JSLogger","MusicConstants","$"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('HoverFlyout'),i=b('JSLogger'),j=b('MusicConstants'),k=b('$'),l=i.create('music_live_listen'),m=(function(){var n=null,o=null,p=[],q=false;return {init:function(){if(q)return;q=true;g.subscribe(j.LIVE_LISTEN_OP.QUEUING_SESSION,m.destroy);},setFlyout:function(r){m.init();n=r;o=new h();o.init(n);p.forEach(m.registerButton);o.subscribe('show',function(){l.log('show_nux');});},destroy:function(){if(o){o.hideFlyout(true);o.destroy();n.destroy();}o=null;n=null;},registerButton:function(r){if(o){o.initNode(r);}else p.push(r);},registerButtonById:function(r){this.registerButton(k(r));}};})();e.exports=a.LiveListenNux||m;});
__d("legacy:LiveListenNux",["LiveListenNux"],function(a,b,c,d){a.LiveListenNux=b('LiveListenNux');},3);
__d("MusicLogger",["AsyncRequest","JSLogger","MusicConstants","Run"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('JSLogger'),i=b('MusicConstants'),j=b('Run'),k=5000,l=h.create('music_logger'),m=null,n={};function o(){m=null;}function p(){if(!m){l.debug('queue_dispatch',k);m=q.defer(k,false);}}function q(s){l.debug('dispatch',{onUnload:s,messages:n});o();if(Object.keys(n).length>0){var t=JSON.stringify(n);n={};var u=new g().setURI('/ajax/music/log.php').setData({types:t});if(s)u.setOption('asynchronous',false);u.send();}}j.onUnload(q.curry(true));var r={PLATFORM:'platform',STATUS_EVENT_VIA:'status_event',BUMP_KEY:'bump_key',log:function(s,t){if(s===r.STATUS_EVENT_VIA)if(t.op!==i.OP.PLAY&&t.op!==i.STATUS_CHANGE_EVENT.playing&&t.op!==i.STATUS_CHANGE_EVENT.track)return;n[s]=n[s]||[];n[s].push(t);p();},dispatchNow:q};e.exports=a.MusicLogger||r;});
__d("Music",["Arbiter","AsyncRequest","Bootloader","ChannelConstants","Dialog","JSLogger","MusicConstants","MusicDiagnostics","MusicEvents","MusicLogger","MusicProviders","MusicWaterfallLogger","Run","areObjectsEqual","copyProperties","emptyFunction","ge","isEmpty"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('ChannelConstants'),k=b('Dialog'),l=b('JSLogger'),m=b('MusicConstants'),n=b('MusicDiagnostics'),o=b('MusicEvents'),p=b('MusicLogger'),q=b('MusicProviders'),r=b('MusicWaterfallLogger'),s=b('Run'),t=b('areObjectsEqual'),u=b('copyProperties'),v=b('emptyFunction'),w=b('ge'),x=b('isEmpty'),y=l.create('music'),z=l.create('music_live_listen'),aa={};function ba(da){return aa[da];}var ca={providers:{},queuedCommand:null,lastStatus:{},_searching:{},lastProviderPlaying:null,addRemoteModule:function(da,ea){aa[da]=ea;},init:function(da,ea){y.debug('init',{music_providers:da,reconnect:ea});for(var fa in da){this._setProviderConfig(fa,u(this._getProviderConfig(fa)||{offline:true},da[fa]));var ga=this._getProviderConfig(fa),ha=this.getRemoteClass(fa);ha.setTokens(ga.tokens,ga.last_used);ea&&ha.reconnect();}this.listenForScrobble();return this;},_getProviderConfig:function(da){return this.providers[da];},_getProviderConfigForLogging:function(da){if(!this._hasProviderConfig(da))return {};var ea=this._getProviderConfig(da);return {offline:ea.offline,last_used:ea.last_used,instance:!!ea.instance};},_setProviderConfig:function(da,ea){this.providers[da]=ea;},_hasProviderConfig:function(da){return !!this._getProviderConfig(da);},persistSearchingFor:function(da,ea){this._searching[da]=true;var fa;if(this._hasProviderConfig(da))fa=this.getRemoteClass(da);fa&&fa.persistSearchingFor&&fa.persistSearchingFor(ea);return this;},getRemoteClass:function(da){if(!this._hasProviderConfig(da)){y.error('provider_not_inited',da);return null;}var ea=this._getProviderConfig(da);if(!ea.instance){switch(da){case q.SPOTIFY:var fa=ba('SpotifyRemote');if(fa){var ga=new fa();ga.init(this._receiveUpdate.bind(this,da),ea);ea.instance=ga;}break;default:var ha=ba('WebBridgeRemote');if(ha){var ia=new ha(this._receiveUpdate.bind(this,da),da,ea);ea.instance=ia;}break;}if(!ea.instance)y.error('provider_module_not_loaded',da);}return ea.instance;},listenForScrobble:function(){g.subscribe(j.getArbiterType('music_scrobbling'),function(da,ea){if(ea.obj.provider_name){ea.obj.provider_data&&this.init(ea.obj.provider_data);this._resetQueuedCommand(ea.obj.provider_name);this.goOnline(ea.obj.provider_name);}}.bind(this));this.listenForScrobble=v;},goOnline:function(da){var ea=(da in this.providers);if(this._isOffline(da)){var fa=this.isManualPlay(da),ga=ea&&this.getRemoteClass(da);ga&&ga.attemptGoOnline(fa);if(!this._searching[da]&&fa&&(!ga||!ga.serviceRunning())){this.persistSearchingFor(da,60);this.launchPlayNowDialog(da,this.queuedCommand.data);}}return this;},goOffline:function(da,ea,fa){if(this._hasProviderConfig(da)){this._resetQueuedCommand(da);this._searching[da]=null;this.getRemoteClass(da).goOffline();}return this;},allProvidersOffline:function(){for(var da in this.providers)if(!this._isOffline(da))return false;return true;},allProvidersPaused:function(){for(var da in this.providers){var ea=this._getLastStatus(da);if(ea&&ea.playing)return false;}return true;},playPauseSongList:function(da,ea,fa,ga,ha){u(ha||{},{song_list:fa,title:ga||''});return this.playPauseSong(da,ea,ha);},playOrResumeSongList:function(da,ea,fa,ga,ha,ia){u(ha||{},{song_list:fa,title:ga||''});var ja=!!this._getProviderConfig(da);if(ia){this.resume(da,ea,ha);}else this.playSong(da,ea,ha);return ja&&this.getRemoteClass(da).serviceRunning();},playPauseSong:function(da,ea,fa){if(!da){da=this.lastProviderPlaying;if(!da)y.error('undefined_provider',da);}y.debug('play_pause_song',{provider:da,provider_config:this._getProviderConfigForLogging(da),uri:ea,data:fa});r.playPause(da);var ga=this._hasProviderConfig(da)?this._getLastStatus(da):{},ha=ga.track&&m.sameURLs(ea,ga.track.uri),ia=ga.context&&m.sameURLs(ea,ga.context.uri),ja=ha||ia;if(ga.playing&&ja){this.pause(da,ea,fa);}else if(ja){this.resume(da,ea,fa);}else this.playSong(da,ea,fa);return this._hasProviderConfig(da)&&this.getRemoteClass(da).serviceRunning();},pauseOtherProviders:function(da){for(var ea in this.providers)if(ea!=da&&!this._isOffline(ea))this.pause(ea);},launchProviderOrPlay:function(da,ea,fa,ga,ha,ia,ja,ka){if(ha){this._diagLogAction(ha,n.SWITCHED_PROVIDER);this.goOffline(ha);}if(!this._isOffline(da)){this.playSong(da,ea,fa);var la=k.getCurrent();la&&la.hide();}else if(da==q.SPOTIFY){this.persistSearchingFor(da,60);this._diagLogAction(da,n.ATTEMPTING_LAUNCH,fa);this.launchPlayNowDialog(da,u({uri:ea},fa),true);}else{!ha&&p.log(p.BUMP_KEY,{provider:da,step:4,status:'okay'});var ma={};ma[da]=ga;this.init(ma);this.launchBridgeProvider(da,ea,fa,ia,ja,ka);this.playSongSafeQueue(da,ea,fa);}},launchBridgeProvider:function(da,ea,fa,ga,ha,ia){if(da==q.SPOTIFY)y.error('invalid_bridge_provider',da);if(!this._isOffline(da)){var ja=k.getCurrent();ja&&ja.hide();return;}this.persistSearchingFor(da,60);var ka=m.sanitizeForProviders(fa);this.getRemoteClass(da).launch(ea,ka,ga,ha,ia);},launchPlayNowDialog:function(da,ea,fa){if(fa)this.queuedCommand={provider:da,op:m.OP.PLAY,data:ea};var ga=u({},ea),ha={url:ga.uri||ga.url,context:ga,listen_to:ga.listen_to||null,button_id:ga.button_id||null};delete ha.context.uri;delete ha.context.url;delete ha.context.listen_to;delete ha.context.button_id;if(this._hasProviderConfig(da)){this.getRemoteClass(da).launchPlayNowDialog(ha);}else{var ia;if(da===q.SPOTIFY){ia='/ajax/music/spotify_play_now.php?init_only';}else ia='/ajax/music/web_bridge_play_now.php?init_only';k.bootstrap(ia,ha,null,null,null,w(ha.button_id));}},playSongSafeQueue:function(da,ea,fa){if(!this._isOffline(da)||!this.queuedCommand||this.queuedCommand.provider!==da){this.playSong(da,ea,fa);}else this._hasProviderConfig(da)&&this.goOnline(da);},playSong:function(da,ea,fa,ga){fa=u(fa||{},{uri:ea});if(ga&&ga.id&&!fa.button_id)fa.button_id=ga.id;this._sendOP(da,m.OP.PLAY,fa);},pause:function(da,ea,fa){fa=u(fa||{},{uri:ea||null});this._sendOP(da,m.OP.PAUSE,fa);},resume:function(da,ea,fa){fa=u(fa||{},{uri:ea});this._sendOP(da,m.OP.RESUME,fa);},queueLiveListenSession:function(da,ea){this.queuedCommand={op:m.LIVE_LISTEN_OP.QUEUE_SESSION,provider:ea,data:da};},attemptLiveListenSessionForProvider:function(da,ea){if(!this._isOffline(ea)&&ea!==q.SPOTIFY){this.getRemoteClass(ea).verifyOnlineState(this._attemptLiveListenSession.bind(this,da,ea));}else this._attemptLiveListenSession(da,ea);},_attemptLiveListenSession:function(da,ea){if(this._isOffline(ea)){this.queueLiveListenSession(da,ea);this.goOnline(ea);}else this._handleQueuedLiveListenSession(da);},_handleQueuedLiveListenSession:function(da){if(!this._checkForValidSpotifyClient(da))return;if(this._privateListeningIsEnabled(da.provider)){this.getRemoteClass(da.provider).send(m.STATUS_CHANGE_OP.STATUS,{});setTimeout(function(ea){var fa=this._privateListeningIsEnabled(ea.provider);if(fa){var ga=u({listen_to:ea.listen_to,provider:ea.provider},fa),ha=new h().setData(ga).setMethod('POST').setURI('/ajax/music/live_listen_private_listening_dialog.php').setErrorHandler(v);new k().setAsync(ha).show();return;}this._handleQueuedLiveListenSession(ea);}.bind(this,da),3000);return;}z.log('queued_session',da);p.log(p.BUMP_KEY,{provider:da.provider,step:501,status:'okay'});new h().setURI('/ajax/music/live_listen.php').setData(da).setHandler(v).setAllowCrossPageTransition(true).send();},_checkForValidSpotifyClient:function(da){if(da.provider==q.SPOTIFY){var ea=this.getLastStatus(da.provider);if(!x(ea)&&ea.client_version&&!m.greaterOrEqualToMinimumVersion(ea.client_version,m.LIVE_LISTEN_MIN_SPOTIFY_VERSION)){var fa=new h().setData({listen_to:da.listen_to}).setMethod('POST').setURI('/ajax/music/live_listen_version_dialog.php').setErrorHandler(v);new k().setAsync(fa).show();return false;}}return true;},_privateListeningIsEnabled:function(da){var ea=this.getLastStatus(da);if(!x(ea)&&ea.open_graph_state&&(ea.open_graph_state.posting_disabled||ea.open_graph_state.private_session))return {posting_disabled:ea.open_graph_state.posting_disabled,private_session:ea.open_graph_state.private_session};if(!x(ea)&&ea.post_open_graph&&(ea.post_open_graph.open_graph_disabled||ea.post_open_graph.private_session))return {posting_disabled:ea.post_open_graph.open_graph_disabled,private_session:ea.post_open_graph.private_session};return false;},reInform:function(da){var ea=[];for(var fa=0;fa<da.length;fa++){var ga=da[fa];if(!this._isOffline(ga))if(ga==this.lastProviderPlaying){ea.push(ga);}else ea.unshift(ga);}for(var fa=0;fa<ea.length;fa++){var ga=ea[fa];y.debug('re_inform',ga);this._receive_STATUS_CHANGE_OP(ga,m.STATUS_CHANGE_OP.REINFORM,this.lastStatus[ga],{});}return this;},isManualPlay:function(da){return !!(this.queuedCommand&&this.queuedCommand.provider===da);},isPlaying:function(da,ea){var fa=this.getLastStatus(da);return fa.playing&&fa.track&&(!ea||m.sameURLs(fa.track.uri,ea));},getLastStatus:function(da){return this._hasProviderConfig(da)?this._getLastStatus(da):{};},_resetQueuedCommand:function(da){if(!da||this.queuedCommand&&this.queuedCommand.provider==da)this.queuedCommand=null;},_receiveUpdate:function(da,ea,fa){y.debug('receive_update',{provider:da,op:ea,data:fa,provider_config:this._getProviderConfigForLogging(da)});if(fa){fa.provider=da;}else fa={provider:da};var ga=v;if(m.DIAGNOSTIC_EVENT[ea]){ga=this._receiveDIAG_EVENT;}else if(m.STATUS_CHANGE_OP[ea]){ga=this._receive_STATUS_CHANGE_OP;}else !m.OP[ea];ga.call(this,da,ea,fa);},_receiveDIAG_EVENT:function(da,ea,fa){var ga=m.DIAGNOSTIC_EVENT;if(ea===ga.ONLINE){this._setOffline(da,false);if(this.queuedCommand&&this.queuedCommand.provider==da)s.onAfterLoad(this._replayQueuedCommand.bind(this,this.queuedCommand.provider,this.queuedCommand.op,this.queuedCommand.data));this._resetQueuedCommand();}else if(ea===ga.IFRAME_POLLING){this._setLastStatus(da,{});}else if(ea===ga.RELAUNCH&&fa.last_sent){this.launchPlayNowDialog(da,fa.last_sent,true);}else if(ea===ga.LOG_SEND_OP){this._logSendOp(da,fa.op,fa.params,fa.replay);}else if(ea===ga.REQUEUE_OP)this._queueAndGoOnline(da,fa.op,fa.params);o.inform(ga[ea],fa);if(ea===ga.OFFLINE){this._setOffline(da,true);this._setLastStatus(da,{});if(this.allProvidersOffline())o.inform(m.DIAGNOSTIC_EVENT.ALL_OFFLINE);}},_receive_STATUS_CHANGE_OP:function(da,ea,fa,ga){ga=ga||this._getLastStatus(da);var ha;for(ha in ga)if(typeof fa[ha]==='undefined')fa[ha]=null;var ia,ja={};this._setLastStatus(da,fa);for(ha in fa){ia=m.STATUS_CHANGE_EVENT[ha];if(ia)if(!ja[ia]&&!t(ga[ha],fa[ha])){if(ea!==m.STATUS_CHANGE_OP.REINFORM)p.log(p.STATUS_EVENT_VIA,{op:ea,provider:da,data:fa});if(fa.playing){if(this.lastProviderPlaying!=da)this.pauseOtherProviders(da);this.lastProviderPlaying=da;}else if(this.allProvidersPaused())o.inform(m.DIAGNOSTIC_EVENT.ALL_PAUSED);o.inform(ia,fa);ja[ia]=1;}}},_replayQueuedCommand:function(da,ea,fa){if(ea===m.OP.PLAY&&this.isPlaying(da,fa.uri))return;y.debug('replay_queued_command',da+":"+ea);if(ea===m.LIVE_LISTEN_OP.QUEUE_SESSION){this._handleQueuedLiveListenSession(fa);return;}fa._isReplayedCommand=true;this._sendOP(da,ea,fa);},_sendOP:function(da,ea,fa){y.debug('send_op',{provider:da,provider_config:this._getProviderConfigForLogging(da),op:ea,data:fa});if(!this._hasProviderConfig(da)){this._queueAndGoOnline(da,ea,fa);}else this.getRemoteClass(da).send(ea,fa);},_logSendOp:function(da,ea,fa){var ga=ea===m.OP.PLAY;if(!fa._isReplayedCommand&&ga)this._diagLogAction(da,n.LAUNCH_NOT_NEEDED);p.log(p.STATUS_EVENT_VIA,{op:ea,provider:da,data:fa});ga&&this._diagLogAction(da,n.PLAY_SONG,fa);},_queueAndGoOnline:function(da,ea,fa){y.debug('queue_and_go_online',{provider:da,op:ea,data:fa});if(!fa._never_queue)this.queuedCommand={op:ea,data:fa,provider:da};if(ea===m.OP.PLAY)this._diagLogAction(da,n.ATTEMPTING_LAUNCH,fa);this.goOnline(da);},_isOffline:function(da){if(!this._hasProviderConfig(da))return true;return this._getProviderConfig(da).offline;},_setOffline:function(da,ea){if(!this._hasProviderConfig(da))return this;this._searching[da]=null;this._getProviderConfig(da).offline=ea;if(!ea&&!this.lastProviderPlaying){this.lastProviderPlaying=da;}else if(ea&&this.lastProviderPlaying==da){this.lastProviderPlaying=null;for(var fa in this.providers)if(this.isPlaying(fa)){this.lastProviderPlaying=fa;break;}else if(!this._isOffline(fa))this.lastProviderPlaying=fa;}return this;},_getLastStatus:function(da){if(!this._hasProviderConfig(da))return {};return this.lastStatus[da]||{};},_setLastStatus:function(da,ea){if(!this._hasProviderConfig(da))return this;this.lastStatus[da]=ea;return this;},_diagLogAction:function(da,ea,fa){n.userAction.curry(da,ea,fa).defer();}};g.subscribe(j.getArbiterType('livelisten_update'),function(da,ea){i.loadModules(['MusicLiveListen'],function(fa){fa.handleUpdate(ea.obj);});});e.exports=a.Music||ca;});
__d("legacy:Music",["Music"],function(a,b,c,d){a.Music=b('Music');},3);
__d("SpotifyAjaxRequest",["ArbiterMixin","Class","ErrorUtils","JSLogger","URI","copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('Class'),i=b('ErrorUtils'),j=b('JSLogger'),k=b('URI'),l=b('copyProperties'),m=b('emptyFunction'),n=j.create('music_spotify'),o=function(){this._request=null;this._data={};this._option={timeout:30000,method:'GET'};this._timeout=null;};l(o,{LOAD_ERROR:'LOAD_ERROR',TIMEOUT_ERROR:'TIMEOUT_ERROR',PARSE_ERROR:'PARSE_ERROR',isSupported:function(){return window.XMLHttpRequest&&typeof XDomainRequest!=='undefined'||('withCredentials' in new XMLHttpRequest());}});l(o.prototype,g,{getDebugData:function(){return {uri:this._uri,data:this._data,options:this._option};},setData:function(p){this._data=p;return this;},setOption:function(p,q){this._option[p]=q;return this;},setURI:function(p){this._uri=k(p);return this;},makeRequestAndOpen:function(){var p=new XMLHttpRequest();if('withCredentials' in p){p.open(this._option.method,this._uri.toString(),true);}else if(typeof XDomainRequest!=='undefined'){p=new XDomainRequest();p.open(this._option.method,this._uri.toString());}else{n.error('not_supported',this.getDebugData());throw new Error('SpotifyAjaxRequest: not supported');}return p;},send:function(){if(this.inform('initial',this)!==false){this._uri.addQueryData(l({cors:''},this._data));this._request=this.makeRequestAndOpen();this._request.ontimeout=m;this._request.onprogress=m;this._request.onload=this._parseResult.bind(this);this._request.onerror=this._dispatchResult.bind(this,'error',{error:{type:o.LOAD_ERROR,message:'the request failed to load at: '+this._uri}});if(this._option.timeout>0)this._timeout=this._dispatchResult.bind(this,'timeout',{error:{type:o.TIMEOUT_ERROR,message:'a timeout occurred after '+this._option.timeout+'ms'}}).defer(this._option.timeout,false);i.applyWithGuard(this._request.send,this._request,null,function(p){n.error('send_error',p);}.bind(this));}return this;},abort:function(){clearTimeout(this._timeout);try{this._request.abort();}catch(p){}this._request=null;this.inform('finish');return this;},_dispatchResult:function(p,q){clearTimeout(this._timeout);this.inform.bind(this,'finish',q).defer();this.inform(p,q);},_parseResult:function(){var p,q,r,s;try{p=this._request.responseText||'';}catch(t){q=o.LOAD_ERROR;r='responseText not available - '+t.message;}if(!q)try{s=JSON.parse(p);}catch(t){q=o.PARSE_ERROR;r='exception parsing JSON - '+t.message;}if(!q&&!s){q=o.PARSE_ERROR;r='empty JSON';}if(q){this._dispatchResult('error',{error:{type:q,message:r}});}else this._dispatchResult(s.error?'error':'success',s);}});e.exports=o;});
__d("SpotifyRemote",["ArbiterMixin","AsyncRequest","Bootloader","Dialog","DOM","JSLogger","MusicConstants","MusicDiagnostics","MusicEvents","MusicProviders","OnloadEvent","Run","SpotifyAjaxRequest","URI","UserAgent","copyProperties","emptyFunction","ge"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('Dialog'),k=b('DOM'),l=b('JSLogger'),m=b('MusicConstants'),n=b('MusicDiagnostics'),o=b('MusicEvents'),p=b('MusicProviders'),q=b('OnloadEvent'),r=b('Run'),s=b('SpotifyAjaxRequest'),t=b('URI'),u=b('UserAgent'),v=b('copyProperties'),w=b('emptyFunction'),x=b('ge'),y=l.create('music_spotify'),z=null;function aa(){}(function(){var ba=window.location.protocol==='https:';v(aa.prototype,g,{PROTOCOL_VERSIONS:[9],serial:1,manualPlay:false,showLoggingin:false,oauthTokenInvalid:false,config:{play_now_url:'/ajax/music/spotify_play_now.php?init_only',oauth_step:8,set_installed_url:'/ajax/music/spotify/installed.php',csrf_uri:'/ajax/music/spotify/set_csrf.php',fetch_oauth_url:'/ajax/music/spotify/auth.php?going_online',retryPeriod:3000,iframeUpdatePeriod:10000,iframeTryCycles:3,longPollPeriod:60000,optimisticPlayNowTime:1000,loggingInTimeout:15000,defaultTimeout:4000,pingPortsTimeout:4000,expBackoffFactor:1.2,maxPollInterval:2200,apPollTimeout:8000},responseCallback:w,tokens:{spotify_csrf:'',spotify_oauth:'',last_timestamp:0},serverConfig:{url:window.location.protocol+'//'+((Math.random()*10000)|0)+'.spotilocal.com',start_port:ba?4370:4380,end_port:ba?4374:4384,path:'/',callbackParam:'callback',ops:{STATUS:'remote/status.json',RESUME:'remote/pause.json?pause=false',PAUSE:'remote/pause.json?pause=true',PLAY:'remote/play.json',VERSION:'service/version.json?service=remote',GET_IFRAME_RESPONSE:'csrf/getFbCsrfToken.html',LOGIN:'remote/login.json'}},STATES:{OFFLINE:'OFFLINE',RESIGNED:'RESIGNED',SEARCHING:'SEARCHING',AUTHENTICATING:'AUTHENTICATING',LOGGED_OUT_AND_WAITING:'LOGGED_OUT_AND_WAITING',FETCHING_OAUTH:'FETCHING_OAUTH',IFRAME_POLLING:'IFRAME_POLLING',RETRYING_TOKENS:'RETRYING_TOKENS',WAITING_TO_AUTH:'WAITING_TO_AUTH',LOGGING_IN:'LOGGING_IN',ONLINE:'ONLINE'},init:function(ca,da){this._iframeTryCount=0;this._providerArgs=da;this._switchToState(this.STATES.OFFLINE);ca&&this.setResponseCallback(ca);this.uri=new t(this.serverConfig.url||'');this.uri.setPath(this.serverConfig.path||'');if(da.fb_csrf)this.fb_csrf=da.fb_csrf;if(!this.serverConfig.start_port)this.serverConfig.start_port=this.serverConfig.port||80;this._hasXDomainXHR=s.isSupported();},persistSearchingFor:function(ca){this._persistFor=ca;var da=this._persistentLoopTimer;this._resetPersistenceTimers();if(da&&this._persistFor)this._persistentLoopTimer=this._giveUpPersisting.bind(this,this._persistFor).defer(this._persistFor*1000,false);},serviceRunning:function(){switch(this.state){case this.STATES.LOGGED_OUT_AND_WAITING:case this.STATES.IFRAME_POLLING:case this.STATES.RETRYING_TOKENS:case this.STATES.FETCHING_OAUTH:case this.STATES.LOGGING_IN:case this.STATES.ONLINE:return true;default:return false;}},attemptGoOnline:function(ca){this.manualPlay=ca;if(!this._hasXDomainXHR&&ba||u.opera()){if(this.manualPlay)j.bootstrap('/ajax/music/spotify/unsupported_browser.php');return;}switch(this.state){case this.STATES.OFFLINE:case this.STATES.RESIGNED:var da=this.serverConfig.start_port||this.serverConfig.port;da&&this.uri.setPort(da);this._switchToState(this.STATES.SEARCHING);this.responseCallback(m.DIAGNOSTIC_EVENT.SEARCHING);if(this._hasXDomainXHR){this._pingPorts();}else i.loadModules(['SpotifyJSONPRequest'],function(ea){z=ea;this._pingPorts();}.bind(this));break;case this.STATES.LOGGED_OUT_AND_WAITING:if(this.manualPlay){this._switchToState(this.STATES.LOGGING_IN);this._send(m.STATUS_CHANGE_OP.LOGIN);}}this.persistSearchingFor(this._persistFor);},reconnect:function(){if(this.state===this.STATES.IFRAME_POLLING){this._cleanupIframe();}else if(this.state===this.STATES.FETCHING_OAUTH){this.fetchedOauth=true;this.oauthTokenInvalid=false;}else{y.error('invalid_reconnect',this.state);return;}this._switchToState(this.STATES.RETRYING_TOKENS);this._send(m.STATUS_CHANGE_OP.STATUS);},setShowLoggingin:function(ca){this.showLoggingin=ca;},setTokens:function(ca,da){ca=ca||{};var ea=this.tokens.last_timestamp<da;if(ca.spotify_csrf&&(!this.tokens.spotify_csrf||ea))this.tokens.spotify_csrf=ca.spotify_csrf;if(ca.spotify_oauth&&(!this.tokens.spotify_oauth||ea))this.tokens.spotify_oauth=ca.spotify_oauth;if(ea&&(ca.spotify_csrf||ca.spotify_oauth))this.tokens.last_timestamp=da;},goOnline:function(){y.log('go_online',{port:this.uri.getPort(),from_state:this.state});this._switchToState(this.STATES.ONLINE);this._stopPersisting();this.oauthTokenInvalid=false;this._iframeTryCount=0;this.responseCallback(m.DIAGNOSTIC_EVENT.ONLINE);this._startPolling();new h(this.config.set_installed_url).setData({set:true,csrf:this.tokens.spotify_csrf}).send();},goOffline:function(){y.log('go_offline',{port:this.uri.getPort(),from_state:this.state});this._switchToState(this.STATES.OFFLINE);clearTimeout(this._authenticatingRetry);this._cleanupIframe();this._stopPersisting();this.oauthTokenInvalid=false;this.fetchedOauth=false;this._iframeTryCount=0;this.responseCallback(m.DIAGNOSTIC_EVENT.OFFLINE);},displayError:function(ca,da){y.error('display_error',{error_code:ca,extra_data:da});var ea=this._getDisplayErrorParams(ca,da);j.bootstrap('/ajax/music/play_error.php',ea);},_getDisplayErrorParams:function(ca,da){var ea={code:ca,provider:p.SPOTIFY};da=da||{};if(da.error_url)ea.url=da.error_url;if(da.song)ea.song=da.song;return ea;},launchPlayNowDialog:function(ca){if(this.state!==this.STATES.LOGGED_OUT_AND_WAITING&&this.serviceRunning())return;this._resetLaunchSubscription();var da=this._launchPlayNow.bind(this,ca);this.prePlayNowLaunchTimer=da.defer(this.config.optimisticPlayNowTime,false);this.launchSubscription=this.subscribe([m.DIAGNOSTIC_EVENT.STATE_CHANGE,m.DIAGNOSTIC_EVENT.WRONG_VERSION],function(ea,fa){if(ea===m.DIAGNOSTIC_EVENT.WRONG_VERSION){this._resetLaunchSubscription();}else switch(fa.to){case this.STATES.OFFLINE:case this.STATES.RESIGNED:this._resetLaunchSubscription();da();break;case this.STATES.AUTHENTICATING:this._resetLaunchSubscription();n.userAction.curry(p.SPOTIFY,n.LAUNCH_NOT_NEEDED).defer();break;}}.bind(this));this.attemptGoOnline(true);},send:function(ca,da){if(this.state===this.STATES.ONLINE){this.responseCallback(m.DIAGNOSTIC_EVENT.LOG_SEND_OP,{op:ca,params:da});this._send(ca,m.sanitizeForProviders(da));}else this.responseCallback(m.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ca,params:da});},setResponseCallback:function(ca){this.responseCallback=ca;},_send:function(ca,da){var ea=false;if(ca===m.OP.PLAY&&da){ea={uri:da.uri};if(da.playlist){ea.context=da.playlist;}else if(da.album){ea.context=da.album;}else if(da.song_list){var fa=da.song_list.indexOf(da.uri),ga=da.song_list.map(function(ka){return ka.replace(/.*\//,'');});ea.context='spotify:trackset:'+escape(da.title||'Facebook')+':'+ga.join(',');}if(da.offset){var ha=Math.floor(da.offset/60),ia=da.offset%60;ea.uri+='#'+ha+':'+ia;}if(da.request_id)ea.request_id=da.request_id;if(da.listen_with_friends)ea.listen_with_friends=da.listen_with_friends;}var ja=ea||da;if(ja&&ja.request_id)ja.request_id=ja.request_id+'';this._createOpRequest(ca,ja).send();n.sendUpdate.curry(p.SPOTIFY,ca,ja).defer();},_launchPlayNow:function(ca){this._resetLaunchSubscription();var da=ca&&ca.context&&ca.context.button_id;j.bootstrap(this.config.play_now_url,ca,null,null,null,x(da));},_resetLaunchSubscription:function(){clearTimeout(this.prePlayNowLaunchTimer);this.launchSubscription&&this.unsubscribe(this.launchSubscription);},_pingPorts:function(){var ca=this.serverConfig.end_port||this.serverConfig.start_port;this.portAttemptCount=ca-this.serverConfig.start_port+1;for(var da=this.serverConfig.start_port;da<=ca;da++){this.uri.setPort(da);this._createOpRequest(m.OP.VERSION).send();}},_stopPersisting:function(){this._persistFor=0;this._resetPersistenceTimers();return this;},_resetPersistenceTimers:function(){clearTimeout(this._persistentLoopTimer);clearTimeout(this._persistentLoopIterationTimer);this._persistentLoopTimer=null;this.loopIterationTime=1000;},_giveUpPersisting:function(ca){y.warn('give_up_persisting',ca);this._stopPersisting();},_pingPortsModeResign:function(){if(this._persistFor){var ca=this.loopIterationTime*this.config.expBackoffFactor;if(ca<this.config.maxPollInterval)this.loopIterationTime=ca;this._persistentLoopIterationTimer=this.attemptGoOnline.bind(this,this.manualPlay).defer(this.loopIterationTime,false);y.debug('persistence_connection_failed','retry in: '+(this.loopIterationTime/1000));this._switchToState(this.STATES.RESIGNED);}else this.goOffline();},_startPolling:function(){if(this.state!==this.STATES.ONLINE||!window.loaded)return false;r.onAfterLoad((function(){this._latestRequest=this._createOpRequest(m.STATUS_CHANGE_OP.STATUS,{returnon:'login,logout,play,error,ap',returnafter:this.config.longPollPeriod/1000});this._latestRequest.subscribe('finish',this._startPolling.bind(this));this._latestRequest.send();}).bind(this));},_pollForAP:function(){this._createOpRequest(m.STATUS_CHANGE_OP.STATUS,{returnon:'ap',returnafter:this.config.apPollTimeout/1000}).send();},_createOpRequest:function(ca,da){if(!this.serverConfig.ops[ca]){y.error('invalid_op',ca);return false;}var ea=this.config.defaultTimeout;if(da&&da.returnon){ea=0;}else if(this.state===this.STATES.SEARCHING){ea=this.config.pingPortsTimeout;}else if(this.state===this.STATES.LOGGING_IN)ea=this.config.loggingInTimeout;var fa=this._hasXDomainXHR?new s():new z();fa.setOption('callbackParam',this.serverConfig.callbackParam).setOption('timeout',ea).setData(v({csrf:this.tokens.spotify_csrf,oauth:this.tokens.spotify_oauth},(da||{}))).setURI(this.uri.toString()+this.serverConfig.ops[ca]);var ga=this.uri.getPort();y.debug('create_op_request',fa.getDebugData());fa.subscribe('success',this._respondToSuccess.bind(this,ca,ga));fa.subscribe('error',this._respondToError.bind(this,ca,ga));fa.subscribe('timeout',this._respondToError.bind(this,ca,ga));return fa;},_respondToSuccess:function(ca,da,ea,fa){y.debug('respond_to_success',{op:ca,port:da,response_data:fa});this.uri.setPort(da);if(fa.hasOwnProperty('online')&&!fa.online)if(this.state!=this.STATES.WAITING_TO_AUTH){this._switchToState(this.STATES.WAITING_TO_AUTH);this._pollForAP();return;}else{this.manualPlay&&this.displayError(4);this.goOffline();}switch(this.state){case this.STATES.SEARCHING:var ga=fa.client_version,ha=fa.version;if(this._isValidClient(ga,ha)){this._switchToState(this.STATES.AUTHENTICATING);this._send(m.STATUS_CHANGE_OP.STATUS);}else{y.error('connecting_schema_version_mismatch',{client_version:ga,protocol_version:ha});this.inform(m.DIAGNOSTIC_EVENT.WRONG_VERSION);if(this.manualPlay)j.bootstrap('/ajax/music/spotify/version_mismatch.php');this.goOffline();return;}break;case this.STATES.LOGGING_IN:case this.STATES.RETRYING_TOKENS:case this.STATES.AUTHENTICATING:this.goOnline();break;case this.STATES.WAITING_TO_AUTH:if(fa.online){this.goOnline();}else{this.manualPlay&&this.displayError(4);this.goOffline();}break;case this.STATES.RESIGNED:case this.STATES.OFFLINE:return;}fa=fa?this._convertURIFields(fa):{};this.error_count=0;this.responseCallback(ca,fa);},_respondToError:function(ca,da,ea,fa){switch(this.state){case this.STATES.SEARCHING:y.debug('connect_miss',da);if(--this.portAttemptCount<=0)this._pingPortsModeResign();return;case this.STATES.RESIGNED:case this.STATES.OFFLINE:y.debug('offline_or_resigned',this.state);return;}if(ca===m.OP.VERSION){y.debug('stray_version');return;}var ga=w,ha=fa||{},ia=this._getError(ha.error.type);y.debug('respond_to_error',{op:ca,port:da,error_code:ia,payload:ha});switch(ia){case 'SERVICE_DEPENDENT_ERRORS':var ja=this._getError(ha.error.type,true),ka=this._getDisplayErrorParams(ja,ha);n.userAction.curry(p.SPOTIFY,m.DIAGNOSTIC_EVENT.SERVICE_ERROR,ka).defer();if(m.STATUS_CHANGE_OP[ca]&&o.inform(m.DIAGNOSTIC_EVENT.SERVICE_ERROR,ka)!==false&&m.ERROR[ja]!=='AUDIO_AD_PLAYING')this.displayError(ja,ha);break;case 'PARSE_ERROR':case 'LOAD_ERROR':case 'TIMEOUT_ERROR':case 'SERVICE_NOT_RESPONDING':case 'UNKNOWN_SERVICE':case 'UNKNOWN_METHOD':case 'ERROR_PARSING_REQUEST':clearTimeout(this._authenticatingRetry);if(ia=='SERVICE_NOT_RESPONDING'&&this.state===this.STATES.AUTHENTICATING){ga=this._pingPortsModeResign;break;}ga=this._loadError;if(this.state===this.STATES.AUTHENTICATING||this.state===this.STATES.RETRYING_TOKENS){this._authenticatingRetry=this._send.bind(this,m.STATUS_CHANGE_OP.STATUS).defer(this.config.retryPeriod,false);}else if(this.state===this.STATES.LOGGING_IN)this._authenticatingRetry=this._send.bind(this,m.STATUS_CHANGE_OP.LOGIN).defer(this.config.retryPeriod,false);break;case 'INVALID_OAUTH_FOR_CURRENT_USER':case 'NO_USER_LOGGED_IN':if(this.state===this.STATES.ONLINE||this.state===this.STATES.WAITING_TO_AUTH){y.debug('user_logged_out');this.goOffline();this._switchToState(this.STATES.LOGGED_OUT_AND_WAITING);return;}else if(this.state===this.STATES.LOGGING_IN){this.oauthTokenInvalid=true;if(!this.fetchedOauth){this._switchToState(this.STATES.FETCHING_OAUTH);new h(this.config.fetch_oauth_url).send();return;}ga=this._authError;}else if(this.manualPlay){this._switchToState(this.STATES.LOGGING_IN);this._send(m.STATUS_CHANGE_OP.LOGIN);}else this._switchToState(this.STATES.LOGGED_OUT_AND_WAITING);break;case 'EXPIRED_OAUTH_TOKEN':case 'LOGIN_BAD_CREDENTIALS':this.oauthTokenInvalid=true;if(!this.fetchedOauth){this._switchToState(this.STATES.FETCHING_OAUTH);new h(this.config.fetch_oauth_url).send();return;}ga=this._authError;break;case 'OAUTH_TOKEN_NOT_VERIFIED':case 'TOKEN_VERIFICATION_TIMEOUT':if(this.state!=this.STATES.WAITING_TO_AUTH){this._switchToState(this.STATES.WAITING_TO_AUTH);this._pollForAP();return;}ga=this._authError;break;case 'INVALID_CSRF_TOKEN':case 'AUTH_FAILED':case 'TOKEN_VERIFICATION_DENIED_TOO_MANY_REQUESTS':ga=this._authError;break;default:y.error('bad_op',{op:ca,payload:ha});break;}ga.call(this,ca,ha);},_loadError:function(ca,da){y.debug('load_error',{op:ca,error_count:this.error_count+1,data:da});this.goOffline();},_authError:function(ca,da){y.error('auth_error',{op:ca,data:da,error_code:this._getError(da.error.type)});if(this.state===this.STATES.WAITING_TO_AUTH){this.manualPlay&&this.displayError(4);this.goOffline();return;}if(this.showLoggingin){this._launchPlayNow({step:10});this.showLoggingin=false;}this._cleanupIframe();if(this._iframeTryCount<=this.config.iframeTryCycles){this._switchToState(this.STATES.IFRAME_POLLING);this._makeIframePollRequest();this.responseCallback(m.DIAGNOSTIC_EVENT.IFRAME_POLLING);}else{if(this.manualPlay)j.bootstrap('/ajax/music/login_error.php');this.goOffline();}},_makeIframePollRequest:function(){var ca=t(window.location.href);if(ca.getSubdomain()=='our')ca=ca.setSubdomain('www');var da=window.location.protocol+'//'+ca.getDomain()+'/',ea=t(da+this.config.csrf_uri).setQueryData({fb_csrf:this.fb_csrf,refresh_token:this.oauthTokenInvalid}),fa=t(this.uri.toString()+this.serverConfig.ops.GET_IFRAME_RESPONSE).setQueryData({set_csrf_path:ea.toString(),cbust:this.serial++});this._cleanupIframe();this._iframe=k.create('iframe',{className:'hidden_elem',src:fa});y.debug('iframe_add',fa);document.body.appendChild(this._iframe);var ga=w;if(++this._iframeTryCount<this.config.iframeTryCycles){ga=function(){this._iframeTryCount>1&&y.debug('iframe_retry');this._makeIframePollRequest();};}else ga=function(){y.error('iframe_retry_exceeded');this._pingPortsModeResign();};this._iframePollTimeout=ga.bind(this).defer(this.config.iframeUpdatePeriod,false);},_cleanupIframe:function(){this._iframePollTimeout&&clearTimeout(this._iframePollTimeout);this._iframe&&y.debug('iframe_remove',this._iframe.id);this._iframe&&k.remove(this._iframe);this._iframe=null;},_switchToState:function(ca){y.debug('switch_state',this.state+" => "+ca);n.stateChanged.curry(p.SPOTIFY,this.state,ca).defer();this.inform(m.DIAGNOSTIC_EVENT.STATE_CHANGE,{from:this.state,to:ca});this.state=ca;},_convertURIFields:function(ca){if(!ca)return null;if(ca.track&&ca.track.track_resource){var da=ca.track;ca.track={uri:da.track_resource.location.og,name:da.track_resource.name};if(da.track_type)ca.track.track_type=da.track_type;if(da.artist_resource)ca.track.artist=da.artist_resource.name;if(da.album_resource)ca.track.album=da.album_resource.name;if(da.length){ca.playing_position=ca.playing_position?Math.floor(ca.playing_position):0;ca.expires_in=da.length-ca.playing_position;ca.expires_in=ca.expires_in<0?0:ca.expires_in;}}if(ca.context&&ca.context.context_resource&&ca.context.context_resource.location){var ea=ca.context;ca.context={uri:ea.context_resource.location.og,name:ea.context_resource.name};if(ea.creator)ca.context.creator=ea.creator.real_name;}for(var fa in ca)if(!m.ALLOWED_STATUS_PARAMS[fa])delete ca[fa];n.receiveUpdate.curry(p.SPOTIFY,ca).defer();return ca;},_isValidClient:function(ca,da){var ea=this._providerArgs.blacklisted_versions,fa=this._providerArgs.minimum_version;return this.PROTOCOL_VERSIONS.indexOf(da)!==-1&&fa&&ea&&ca&&ea.indexOf(ca)===-1&&m.greaterOrEqualToMinimumVersion(ca,fa);},_getError:function(ca,da){if(!da&&!isNaN(parseFloat(ca)))if(ca>=4200&&ca<=4399)return this._errorMap['4200 - 4399'];return this._errorMap[ca];},_errorMap:{'4200 - 4399':'SERVICE_DEPENDENT_ERRORS',4201:1,4202:2,4203:3,4204:4,4205:5,4301:101,4302:102,4303:103,'4000 - 4099':'GENERAL_RPC_ERRORS',4001:'UNKNOWN_METHOD',4002:'ERROR_PARSING_REQUEST',4003:'UNKNOWN_SERVICE',4004:'SERVICE_NOT_RESPONDING','4100 - 4199':'RPC_AUTHENTICATION_ERRORS',4102:'LOGIN_BAD_CREDENTIALS',4103:'EXPIRED_OAUTH_TOKEN',4104:'OAUTH_TOKEN_NOT_VERIFIED',4105:'TOKEN_VERIFICATION_DENIED_TOO_MANY_REQUESTS',4106:'TOKEN_VERIFICATION_TIMEOUT',4107:'INVALID_CSRF_TOKEN',4108:'INVALID_OAUTH_FOR_CURRENT_USER',4109:'INVALID_CSRF_PATH',4110:'NO_USER_LOGGED_IN',LOAD_ERROR:'LOAD_ERROR',TIMEOUT_ERROR:'TIMEOUT_ERROR',PARSE_ERROR:'PARSE_ERROR'}});})();e.exports=a.SpotifyRemote||aa;});
__d("WebBridgeRemote",["event-extensions","Arbiter","ArbiterMixin","AsyncRequest","Class","CSS","Dialog","DOM","Env","JSLogger","MusicConstants","MusicDiagnostics","URI","UserAgent","$","copyProperties","cx","emptyFunction","ge","swfobject2"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AsyncRequest'),j=b('Class'),k=b('CSS'),l=b('Dialog'),m=b('DOM'),n=b('Env'),o=b('JSLogger'),p=b('MusicConstants'),q=b('MusicDiagnostics'),r=b('URI'),s=b('UserAgent'),t=b('$'),u=b('copyProperties'),v=b('cx'),w=b('emptyFunction'),x=b('ge'),y=b('swfobject2'),z=o.create('music_web_bridge');function aa(ba,ca,da){this.responseCallback=ba;this.provider=ca;if(!da.external_player)return;this.externalPlayer=this._getExternalPlayer(da.external_player);this.connectionName=r(this.externalPlayer).getDomain();this.state=aa.STATES.OFFLINE;this.lastSentMsg=null;this.wasOnline=false;this.connectionAttempts=0;this.lastStatusCheck=0;g.subscribe('MusicFlashBridge.'+this.provider+'.status',this.reportStatus.bind(this));g.subscribe('MusicFlashBridge.'+this.provider+'.initialized',function(){this._flashBridgeReady.bind(this).defer();}.bind(this));s.osx()&&Event.listen(window,'focus',this._onFocus.bind(this));s.osx()&&Event.listen(window,'blur',this._onBlur.bind(this));}u(aa,{minFlashVersion:'10.3.181.34',flashBridgeSWF:'/music/flash/MusicFlashBridge.swf',configure:function(ba){z.debug('configure',ba);aa.minFlashVersion=ba.minFlashVersion;aa.flashBridgeSWF=ba.flashBridgeSWF;},STATES:{OFFLINE:'OFFLINE',BRIDGE_WAITING:'BRIDGE_WAITING',BRIDGE_READY:'BRIDGE_READY',ONLINE:'ONLINE'},PLAY_NOW_URL:'/ajax/music/web_bridge_play_now.php?init_only',ERROR_DIALOG:'/ajax/music/play_error.php',TOS_URL:'/music/tos_launch_player.php',OPTIMISTIC_PLAYNOW_TIME:2000,UNLOAD_ON_BLUR_DELAY:3000,REMOTE_CONNECTION_INTERVAL:1500,REMOTE_CONNECTION_TIMEOUT_MANUAL:60,REMOTE_CONNECTION_TIMEOUT_AUTO:5,REMOTE_CONNECTION_RETRY_TIMEOUT:4000,RECHECK_STATUS_ON_SEND_INTERVAL:10000,RECHECK_STATUS_SEND_TIMEOUT:500,hasMinFlashVersion:function(){if(!y.hasFlashPlayerVersion(this.minFlashVersion)){z.bump('flash_upgrade');new i().setURI('/ajax/flash_update_dialog.php').setMethod('GET').setReadOnly(true).send();return false;}return true;},getFlashMovieObject:function(ba){if(document[ba])return document[ba];if(document.embeds&&document.embeds[ba])return document.embeds[ba];return x(ba);},removeFlashMovieObject:function(ba){if(document[ba])document[ba]=null;if(document.embeds&&document.embeds[ba])document.embeds[ba]=null;if(x(ba))m.remove(ba);}});u(aa.prototype,h,{responseCallback:w,flashBridge:null,persistFor:0,persistSearchingFor:function(ba){this.connectionAttempts=0;this.persistFor=ba;this.maxConnectAttempts=Math.floor((ba*1000)/aa.REMOTE_CONNECTION_INTERVAL);if(this.state===aa.STATES.OFFLINE)this._initFlashBridge();},attemptGoOnline:function(ba){var ca=ba?aa.REMOTE_CONNECTION_TIMEOUT_MANUAL:aa.REMOTE_CONNECTION_TIMEOUT_AUTO;if(ca<this.persistFor)ca=this.persistFor;this.persistSearchingFor(ca);},goOffline:function(){z.log('go_offline',{provider:this.provider,from_state:this.state});this._switchToState(aa.STATES.OFFLINE);this._removeFlashBridge();this._resetClientPoll();this.responseCallback(p.DIAGNOSTIC_EVENT.OFFLINE);},serviceRunning:function(){return this.state===aa.STATES.ONLINE;},reconnect:function(){},setTokens:function(ba){},send:function(ba,ca){if(this.state===aa.STATES.ONLINE){this._resetSendSubscription();var da=function(){this._resetSendSubscription();this.responseCallback(p.DIAGNOSTIC_EVENT.LOG_SEND_OP,{op:ba,params:ca});this._send(ba,p.sanitizeForProviders(ca));}.bind(this);if(Date.now()-aa.RECHECK_STATUS_ON_SEND_INTERVAL>this.lastStatusCheck){this._sendTimer=da.defer(aa.RECHECK_STATUS_SEND_TIMEOUT,false);this._sendSubscription=this.subscribe(p.DIAGNOSTIC_EVENT.MISS,function(ea,fa){q.stateChanged(this.provider,null,null,p.DIAGNOSTIC_EVENT.INCORRECT_ONLINE_STATE);this._resetSendSubscription();this.goOffline();this.responseCallback(p.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ba,params:ca});}.bind(this));this._send(p.STATUS_CHANGE_OP.STATUS,{});}else da();}else this.responseCallback(p.DIAGNOSTIC_EVENT.REQUEUE_OP,{op:ba,params:ca});},verifyOnlineState:function(ba){if(this.state!==aa.STATES.ONLINE){ba();}else{ba.defer(500,false);this._send(p.STATUS_CHANGE_OP.STATUS,{_never_queue:true});}},_resetSendSubscription:function(){this._sendTimer&&clearTimeout(this._sendTimer);this._sendSubscription&&this.unsubscribe(this._sendSubscription);this._sendSubscription=this._sendTimer=null;},_send:function(ba,ca){switch(ba){case p.OP.PLAY:case p.OP.RESUME:case p.OP.PAUSE:this.lastSentMsg={};u(this.lastSentMsg,ca);if(ca.radio_station||ca.album||ca.playlist||ca.musician){delete ca.song_list;}else if(!ca.song)ca.song=ca.uri;delete ca.uri;break;case p.STATUS_CHANGE_OP.STATUS:this.lastStatusCheck=Date.now();break;default:z.error('invalid_op',{provider:this.provider,op:ba});return;}if(this.flashBridge&&!this._unloadIfNeeded()){z.debug('send',{provider:this.provider,op:ba,params:ca});z.rate('flash_movie_valid',(typeof this.flashBridge.send)==='function');this.flashBridge.send(ba,ca);q.sendUpdate.curry(this.provider,ba,ca).defer();}},launch:function(ba,ca,da,ea,fa){var ga=this.provider.replace(/\.|-/g,'_'),ha=r(this.externalPlayer).addQueryData(ca),ia=ha;if(da)ia=r(aa.TOS_URL).addQueryData({player_url:ha.toString(),url:ba,perms:da,get_dtsg:n.fb_dtsg}).addQueryData(fa);window.open(ia,ga);q.sendUpdate.curry(this.provider,q.WINDOW_OPEN,ca).defer();var ja={url:ba,step:9};if(ea)ja=u(ja,ea);z.debug('launch',{provider:this.provider,params:ja});this._launchPlayNow(ja);},launchPlayNowDialog:function(ba){if(this.serviceRunning())return;this._resetLaunchSubscription();var ca=this._launchPlayNow.bind(this,ba);this.prePlayNowLaunchTimer=ca.defer(aa.OPTIMISTIC_PLAYNOW_TIME,false);this.launchSubscription=this.subscribe([p.DIAGNOSTIC_EVENT.MISS,p.DIAGNOSTIC_EVENT.STATE_CHANGE],function(da,ea){if(da===p.DIAGNOSTIC_EVENT.MISS){this._resetLaunchSubscription();ca();}else if(ea.to===aa.STATES.ONLINE){this._resetLaunchSubscription();q.userAction.curry(this.provider,q.LAUNCH_NOT_NEEDED).defer();}}.bind(this));this.attemptGoOnline(true);},reportStatus:function(ba,ca){var da=ca.op,ea=ca.args;clearTimeout(this._pollTimeout);if(ea.error_code){q.userAction.curry(this.provider,p.DIAGNOSTIC_EVENT.SERVICE_ERROR,{code:ea.error_code}).defer();var fa=p.ERROR[ea.error_code];switch(fa){case 'AUDIO_AD_PLAYING':z.log('report_status_ad_playing',{error:fa,provider:this.provider,args:ea});break;default:var ga={code:ea.error_code,provider:this.provider};if(ea.song)ga.song=ea.song;if(ea.redirect_url)ga.url=ea.redirect_url;l.bootstrap(aa.ERROR_DIALOG,ga);z.error('report_status_error',{error:fa,provider:this.provider,args:ea});return;}}if(ea.offline){this.goOffline();}else if(da===p.DIAGNOSTIC_EVENT.MISS){this.inform(da,ea);if(this.state!==aa.STATES.ONLINE&&this.state!==aa.STATES.OFFLINE){if(this.connectionAttempts<this.maxConnectAttempts){this._pollForClient.bind(this).defer(aa.REMOTE_CONNECTION_INTERVAL,false);}else this.goOffline();}else if(this.state===aa.STATES.ONLINE){this.goOffline();if(this.lastSentMsg&&this.lastSentMsg.uri)this.responseCallback(p.DIAGNOSTIC_EVENT.RELAUNCH,{last_sent:this.lastSentMsg});return;}}else if(this.state===aa.STATES.BRIDGE_READY){this.wasOnline=true;this._switchToState(aa.STATES.ONLINE);this.responseCallback(p.DIAGNOSTIC_EVENT.ONLINE);}if(da===p.STATUS_CHANGE_OP.STATUS)q.receiveUpdate.curry(this.provider,ea).defer();if(ea.radio_station||ea.song){ea.track={};ea.track.uri=ea.radio_station||ea.song;ea.track.songuri=ea.song;}if(ea.radio_station){ea.context={name:ea.title,uri:ea.radio_station};}else if(ea.playlist){ea.context={name:ea.title,uri:ea.playlist};}else if(ea.album){ea.context={name:ea.title,uri:ea.album};}else if(ea.musician)ea.context={name:ea.title,uri:ea.musician};this.responseCallback.apply(this,[da].concat(ea));},_onFocus:function(){clearTimeout(this._blurTimeout);if(!this.wasOnline)return;if(!this.flashBridge){this.persistSearchingFor(aa.REMOTE_CONNECTION_TIMEOUT_AUTO);}else{z.rate('flash_movie_valid',(typeof this.flashBridge.activate)==='function');this.flashBridge.activate();}},_onBlur:function(){if(this.flashBridge){clearTimeout(this._blurTimeout);this._blurTimeout=function(){this._unloadIfNeeded();}.bind(this).defer(aa.UNLOAD_ON_BLUR_DELAY);}},_unloadIfNeeded:function(){if(this.flashBridge)if(s.osx()){var ba=(typeof this.flashBridge.shouldUnload==='function');z.rate('flash_movie_valid',ba);if(!ba||this.flashBridge.shouldUnload()){this.goOffline();return true;}}return false;},_launchPlayNow:function(ba){var ca=ba&&ba.context&&ba.context.button_id;this._resetLaunchSubscription();l.bootstrap(aa.PLAY_NOW_URL,ba,null,null,null,x(ca));},_resetLaunchSubscription:function(){clearTimeout(this.prePlayNowLaunchTimer);this.launchSubscription&&this.unsubscribe(this.launchSubscription);},_initFlashBridge:function(){this.flashBridge=aa.getFlashMovieObject(this.provider);if(!this.flashBridge){this._switchToState(aa.STATES.BRIDGE_WAITING);var ba=this.provider+'_container';document.body.appendChild(m.create('div',{id:ba}));y.embedSWF(aa.flashBridgeSWF,ba,'1px','1px',aa.minFlashVersion,null,{swf_id:this.provider,name:this.connectionName,user_id:n.user},{allowscriptaccess:'always'},null,function(ca){z.rate('flash_bridge_init',ca.success);z.debug('flash_bridge_init',ca.success);this.flashBridge=ca.ref;if(this.flashBridge)k.addClass(this.flashBridge,"_2px");}.bind(this));}else this._flashBridgeReady();},_removeFlashBridge:function(){if(this.flashBridge){z.debug('flash_bridge_unload',this.provider);var ba=this.provider+'_container';y.removeSWF(ba);this.flashBridge=null;}},_switchToState:function(ba){z.debug('switch_state',this.provider+": "+this.state+" => "+ba);q.stateChanged.curry(this.provider,this.state,ba).defer();this.inform(p.DIAGNOSTIC_EVENT.STATE_CHANGE,{from:this.state,to:ba});this.state=ba;},_flashBridgeReady:function(){z.debug('flash_bridge_ready',{provider:this.provider,state:this.state});if(this.state!=aa.STATES.ONLINE){this._switchToState(aa.STATES.BRIDGE_READY);this._pollForClient();}},_resetClientPoll:function(){this.connectionAttempts=0;this.persistFor=0;clearTimeout(this._pollTimeout);},_pollForClient:function(){if(!this.flashBridge||((typeof this.flashBridge.send)!=='function')||this.state==aa.STATES.OFFLINE)return;this._send(p.STATUS_CHANGE_OP.STATUS,{});var ba;if(++this.connectionAttempts<this.maxConnectAttempts){ba=function(){if(this.state==aa.STATES.OFFLINE)return;z.debug('poll_for_client',{provider:this.provider,connection_attempts:this.connectionAttempts});clearTimeout(this._pollTimeout);this._pollForClient();};}else ba=function(){z.debug('timeout_max_connection_attempts',this.provider);this.goOffline();};this._pollTimeout=ba.bind(this).defer(aa.REMOTE_CONNECTION_RETRY_TIMEOUT,false);},_getExternalPlayer:function(ba){return ba;}});e.exports=a.WebBridgeRemote||aa;});