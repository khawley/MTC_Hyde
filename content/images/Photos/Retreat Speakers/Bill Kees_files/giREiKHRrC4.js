/*1349661965,173213725*/

if (window.CavalryLogger) { CavalryLogger.start_js(["0yayH"]); }

__d("DOMWrapper",[],function(a,b,c,d,e,f){var g,h,i={setRoot:function(j){g=j;},getRoot:function(){return g||document.body;},setWindow:function(j){h=j;},getWindow:function(){return h||self;}};e.exports=i;});
__d("legacy:FreeformTokenizerBehavior",["FreeformTokenizerBehavior"],function(a,b,c,d){var e=b('FreeformTokenizerBehavior');if(!a.TokenizerBehaviors)a.TokenizerBehaviors={};a.TokenizerBehaviors.freeform=e;},3);
__d("Flash",["DOMWrapper","QueryString","UserAgent","copyProperties","guid"],function(a,b,c,d,e,f){var g=b('DOMWrapper'),h=b('QueryString'),i=b('UserAgent'),j=b('copyProperties'),k=b('guid'),l={},m,n=g.getWindow().document;function o(t){var u=n.getElementById(t);if(u)u.parentNode.removeChild(u);delete l[t];}function p(){for(var t in l)if(l.hasOwnProperty(t))o(t);}function q(t){return t.replace(/\d+/g,function(u){return '000'.substring(u.length)+u;});}function r(t){if(!m){if(i.ie()>=9)window.attachEvent('onunload',p);m=true;}l[t]=t;}var s={embed:function(t,u,v,w){var x=k();t=encodeURI(t);v=j({allowscriptaccess:'always',flashvars:w,movie:t},v||{});if(typeof v.flashvars=='object')v.flashvars=h.encode(v.flashvars);var y=[];for(var z in v)if(v.hasOwnProperty(z)&&v[z])y.push('<param name="'+encodeURI(z)+'" value="'+encodeURI(v[z])+'">');var aa=n.createElement('div'),ba='<object '+(i.ie()?'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ':'type="application/x-shockwave-flash"')+'data="'+t+'" '+'id="'+x+'">'+y.join('')+'</object>';aa.innerHTML=ba;var ca=u.appendChild(aa.firstChild);r(x);return ca;},remove:o,getVersion:function(){var t='Shockwave Flash',u='application/x-shockwave-flash',v='ShockwaveFlash.ShockwaveFlash',w;if(navigator.plugins&&typeof navigator.plugins[t]=='object'){var x=navigator.plugins[t].description;if(x&&navigator.mimeTypes&&navigator.mimeTypes[u]&&navigator.mimeTypes[u].enabledPlugin)w=x.match(/\d+/g);}if(!w)try{w=(new ActiveXObject(v)).GetVariable('$version').match(/(\d+),(\d+),(\d+),(\d+)/);w=Array.prototype.slice.call(w,1);}catch(y){}return w;},checkMinVersion:function(t){var u=s.getVersion();if(!u)return false;return q(u.join('.'))>=q(t);},isAvailable:function(){return !!s.getVersion();}};e.exports=s;});
__d("PhotoTagStore",["AsyncRequest","copyProperties","isEmpty"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('copyProperties'),i=b('isEmpty');function j(){this._tagList={};this._textTagList={};this._originalTagList={};this._dirtyPhotosByUid={};j.instance=this;}j.instance=null;j.getInstance=function(){if(j.instance===null)new j();return j.instance;};h(j.prototype,{getPhotoTags:function(k){return this._tagList[k]||{};},clear:function(){this._tagList={};this._textTagList={};this._originalTagList={};this._dirtyPhotosByUid={};},revert:function(k){for(var l in this._tagList)if(!this._originalTagList[l][k]){delete this._tagList[l][k];}else this._tagList[l][k]=this._originalTagList[l][k];this._dirtyPhotosByUid={};},hasNewTags:function(){return !i(this._tagList)||!i(this._textTagList);},userHasDirtyTags:function(k){return !i(this._dirtyPhotosByUid[k]);},handleTagFetch:function(k){for(var l in k)this.loadTagInfo(l,k[l]);},saveAlbumTagsForUser:function(k,l){var m={},n=[],o=this._dirtyPhotosByUid[k]||{};for(var p in o){var q=this._tagList[p][k];if(q===undefined){n[n.length]=p;continue;}m[p]={x:q.x,y:q.y};}var r={subject:k,action:'save',save_tags:m,remove_from:n};new g().setURI('/ajax/photos/album/tags.php').setData(r).setHandler(function(s){l(s.payload);}).setAllowCrossPageTransition(true).send();delete this._dirtyPhotosByUid[k];},getTagsFromList:function(k){var l=[];for(var m in k)if(k.hasOwnProperty(m))for(var n in k[m])if(k[m].hasOwnProperty(n))l.push(k[m][n]);return l;},getAllTags:function(){var k=this.getTagsFromList(this._tagList),l=this.getTagsFromList(this._textTagList);return k.concat(l);},removeTag:function(k,l){var m=this._tagList[k],n=this._originalTagList[k]||{};if(n[l]){this._dirtyPhotosByUid[l]=this._dirtyPhotosByUid[l]||{};this._dirtyPhotosByUid[l][k]=true;}else delete this._dirtyPhotosByUid[l][k];for(var o in m)if(o==l){delete this._tagList[k][o];if(i(this._tagList[k]))delete this._tagList[k];}},removeTextTag:function(k,l){var m=this._textTagList[k];if(!i(m[l])){delete this._textTagList[k][l];if(i(this._textTagList[k]))delete this._textTagList[k];}},removeAllTagsFromPhoto:function(k){if(!i(this._tagList[k]))for(var l in this._tagList[k]){if(!this._tagList[k].hasOwnProperty(l))continue;this.removeTag(k,l);}if(!i(this._textTagList[k]))for(var m in this._textTagList[k]){if(!this._textTagList[k].hasOwnProperty(m))continue;this.removeTextTag(k,m);}},storeTag:function(k,l,m,n,o){this.storeTagWithOptions(k,l,m,n,{can_remove:o});},storeTagWithOptions:function(k,l,m,n,o){this._dirtyPhotosByUid[l]=this._dirtyPhotosByUid[l]||{};this._dirtyPhotosByUid[l][k]=true;var p={x:m,y:n};h(p,o);if(!l){this._textTagList[k]=this._textTagList[k]||{};this._textTagList[k][p.name]=p;}else{this._tagList[k]=this._tagList[k]||{};this._tagList[k][l]=p;}},loadTagInfo:function(k,l){this._tagList[k]={};this._originalTagList[k]={};for(var m=0;m<l.length;m++){var n=l[m];this._tagList[k][n.subject]=n;this._originalTagList[k][n.subject]=n;}}});e.exports=j;});
__d("PhotosUploadWaterfall",["AsyncSignal"],function(a,b,c,d,e,f){var g=b('AsyncSignal'),h={APP_FLASH:'flash_pro',APP_SIMPLE:'simple',APP_COMPOSER:'composer',INSTALL_CANCEL:1,INSTALL_INSTALL:2,INSTALL_UPDATE:3,INSTALL_REINSTALL:4,INSTALL_PERMA_CANCEL:5,INSTALL_SILENT_SKIP:6,INSTALL_DOWNLOAD:7,BEGIN:1,UPLOAD_START:4,ALL_UPLOADS_DONE:6,IMAGES_SELECTED:9,UPGRADE_REQUIRED:11,VERSION:15,CANCEL:22,PROGRESS_BAR_STOPPED:44,MISSED_BEAT:45,HEART_ATTACK:46,OVERLAY_FIRST:61,VAULT_COMPOSER_IMAGES_SELECTED:62,sendSignal:function(i,j){new g('/ajax/photos/waterfall.php',{data:JSON.stringify(i)}).setHandler(j).send();}};e.exports=h;});
__d("UploadEvent",[],function(a,b,c,d,e,f){var g={DONE:'UploadEvent/DONE',ERROR:'UploadEvent/ERROR',FINISHED_UPLOADING:'UploadEvent/FINISHED_UPLOADING',LOADED:'UploadEvent/LOADED',READY:'UploadEvent/READY',UPLOAD_FAILED:'UploadEvent/UPLOAD_FAILED',UPLOAD_PROGRESS:'UploadEvent/UPLOAD_PROGRESS',COMPRESS_PROGRESS:'UploadEvent/COMPRESS_PROGRESS',HI_RES_ATTACH_START:'UploadEvent/HI_RES_ATTACH_START',IMAGE_COMPRESS_ERROR:'UploadEvent/IMAGE_COMPRESS_ERROR',IMAGE_COMPRESSED:'UploadEvent/IMAGE_COMPRESSED',IMAGE_UPLOAD_ERROR:'UploadEvent/IMAGE_UPLOAD_ERROR',IMAGE_UPLOADED:'UploadEvent/IMAGE_UPLOADED',IMAGES_SELECTED:'UploadEvent/IMAGES_SELECTED',SELECT_CANCELED:'UploadEvent/SELECT_CANCELED',SELECT_DOWN:'UploadEvent/SELECT_DOWN',SELECT_OUT:'UploadEvent/SELECT_OUT',SELECT_OVER:'UploadEvent/SELECT_OVER',SELECT_UP:'UploadEvent/SELECT_UP',HEARTBEAT:'UploadEvent/HEARTBEAT'};e.exports=g;});
__d("FlashUploadController",["array-extensions","Arbiter","AsyncRequest","PhotosUploadWaterfall","Flash","Run","UploadEvent","$","copyProperties","createArrayFrom","getObjectValues"],function(a,b,c,d,e,f){b('array-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('PhotosUploadWaterfall'),j=b('Flash'),k=b('Run'),l=b('UploadEvent'),m=b('$'),n=b('copyProperties'),o=b('createArrayFrom'),p=b('getObjectValues');function q(r,s,t,u,v){q.init();n(this,{_isRecognitionFinished:false,_flashIDs:[],_initialMaxSelectable:s.maxSelectable,_addedPostParams:[],_waterfall_id:s.qn,_on_flash_error:t,_albumLimitExceeded:0,_uploading:false,_heartbeats:{},_stopHeartbeat:false,_isReady:{},_errors:[],_subscriptions:[],_recognitionConfig:{pollAttempts:s.recognitionPollAttempts,pollPeriod:s.recognitionPollPeriod,url:s.recognitionUrl,aid:s.aid,owner:s.owner},_flashStats:{},_uploaderName:s.uploaderName});this.registerSwf(r);if(!this.checkMinimumFlash(s.flashVersionInfo.minimumVersion)){i.sendSignal({qn:s.qn,step:i.UPGRADE_REQUIRED,uploader:this._uploaderName});u&&u(q.ERROR_FLASH_UPGRADE_REQUIRED);return;}['flash/ready','flash/failed',l.DONE,l.ERROR,l.FINISHED_UPLOADING,l.IMAGES_SELECTED,l.READY,l.UPLOAD_FAILED,l.UPLOAD_PROGRESS,l.HEARTBEAT].forEach(this._subscribe.bind(this,g.SUBSCRIBE_ALL));k.onLeave(this.destroy.bind(this));if(!this.checkMinimumFlash([s.flashVersionInfo.latestVersion]))v&&v();window.setTimeout(function(){if(!this.isReady())t(q.ERROR_FLASH_LOAD_TIMEOUT);}.bind(this),s.flashLoadTimeout);}n(q,{ERROR_FLASH_LOAD_TIMEOUT:1,ERROR_FLASH_LOAD_FAILURE:2,ERROR_FLASH_UPGRADE_REQUIRED:3,_inited:false,init:function(){if(this._inited)return;this._inited=true;}});n(q.prototype,{destroy:function(){while(this._subscriptions.length)g.unsubscribe(this._subscriptions.pop());},_subscribe:function(r,s){this._subscriptions.push(g.subscribe(s,this.arbiterFilter.bind(this),r));},registerSwf:function(r){if(!this._flashIDs.contains(r)){this._flashIDs.push(r);this._flashStats[r]=null;}},_sumStat:function(r){var s=0;p(this._flashStats).forEach(function(t){if(t&&t[r])s+=t[r];});return s;},getMaxSelectable:function(){if(this._initialMaxSelectable===-1)return -1;var r=this._initialMaxSelectable-this.getImagesSelected()+this.getImagesFailed();return Math.max(r,0);},getImagesUploaded:function(){return this._sumStat('filesUploaded');},getImagesFailed:function(){return this._sumStat('filesFailed');},getImagesSelected:function(){return this._sumStat('totalFiles');},isAlbumLimitExceeded:function(){return this._albumLimitExceeded;},isReady:function(){var r=true;this._flashIDs.forEach(function(s){if(!this._isReady[s])r=false;}.bind(this));return r;},isUploading:function(){return this._uploading;},getPercentComplete:function(){var r=this._sumStat('originalFileBytesUploaded'),s=this._sumStat('totalOriginalFileBytes');return r/s*100;},getErrors:function(){return this._errors;},checkMinimumFlash:function(r){for(var s=0;s<r.length;++s)if(j.checkMinVersion(r[s].toString()))return true;return false;},setAid:function(r){this._callAllSWFs(true,'setAid',r);this._recognitionConfig.aid=r;},handleImagesSelected:function(r){this._albumLimitExceeded=r.maxReached;this._flashStats[r.divID]=r.stats;this._callAllSWFs(true,'setMaxSelectable',this.getMaxSelectable());i.sendSignal({qn:this._waterfall_id,step:i.IMAGES_SELECTED,count:r.count,uploader:this._uploaderName});},addPostParam:function(r,s){this._addedPostParams.push({name:r,value:s});this._flashIDs.forEach(function(t,u){var v=this._flash(u);v.addPostParam&&v.addPostParam(r,s);}.bind(this));},markDeleted:function(r){this._callAllSWFs(false,'markDeleted',r);this.refreshStats();this._callAllSWFs(false,'setMaxSelectable',this.getMaxSelectable());},isEventIntendedForMe:function(r){return 'divID' in r&&this._flashIDs.contains(r.divID);},arbiterFilter:function(r,s){if(!this.isEventIntendedForMe(s))return;switch(r){case 'flash/failed':this.handleFlashFailed();return;case 'flash/ready':this.handleFlashReady.bind(this,s).defer();return;case l.UPLOAD_FAILED:this._uploading=false;return;case l.IMAGES_SELECTED:this.handleImagesSelected(s);return;case l.FINISHED_UPLOADING:this.handleFinishedUploading(s);return;case l.ERROR:this._errors.push(s.metrics);this._flashStats[s.divID]=s.stats;this._callAllSWFs(true,'setMaxSelectable',this.getMaxSelectable());return;case l.UPLOAD_PROGRESS:this._flashStats[s.divID]=s.stats;return;case l.HEARTBEAT:this._heartbeats[s.divID]={stamp:s.timestamp,timer:null};return;default:return;}},handleFinishedUploading:function(r){this._uploading=false;if(this.uploadImages())return;i.sendSignal({qn:this._waterfall_id,step:i.ALL_UPLOADS_DONE,uploader:this._uploaderName});if(this._recognitionConfig.url&&!this._recognitionStarted){this._recognitionStarted=true;this.startRecognition();}else this.recognitionFinished();},recognitionFinished:function(){this._isRecognitionFinished=true;g.inform(l.DONE,{divID:this._flashIDs[0]});},isRecognitionFinished:function(){return this._isRecognitionFinished;},handleFlashReady:function(r){if(!this._isReady[r.divID])this._isReady[r.divID]=true;var s=this._flash(this._flashIDs.indexOf(r.divID));this._addedPostParams.forEach(function(t){s.addPostParam(t.name,t.value);});this._callAllSWFs(true,'setMaxSelectable',this.getMaxSelectable());g.inform(l.READY,r);this._heartbeats[r.divID]={stamp:Date.now(),timer:null};this._heartbeat(r.divID);},_heartbeat:function(r){if(this._stopHeartbeat)return;var s=7500,t=Date.now();this._heartbeats[r].stamp<(t-s*2);this._heartbeats[r].timer&&clearTimeout(this._heartbeats[r].timer);this._heartbeats[r].timer=this._heartbeat.bind(this,r).defer(s,true);try{this._flash(this._flashIDs.indexOf(r)).heartbeat(t);}catch(u){}},handleFlashFailed:function(){if(this._on_flash_error)this._on_flash_error(q.ERROR_FLASH_LOAD_FAILURE);},_callAllSWFs:function(r,s){var t=o(arguments).slice(2,arguments.length);for(var u=0;u<this._flashIDs.length;u++){var v=this._flash(u),w=v[s];if(typeof w!=='function')continue;if(r){(function(y,z){try{y.apply(z,t);}catch(aa){}}).bind(this,w,v).defer();}else try{w.apply(v,t);}catch(x){}}},_flash:function(r){var s=this._flashIDs[r||0];return m(s);},refreshStats:function(){for(var r=0;r<this._flashIDs.length;r++){var s=this._flash(r);if(s&&s.getStats)this._flashStats[this._flashIDs[r]]=s.getStats();}},getStats:function(r){var s={elapsedTime:0,estimatedTotalTime:null,estimatedTimeToComplete:null,percentCompleted:0,nextPercentTarget:0,estimatedTimeToNextTarget:null,filesUploaded:0,filesFailed:0,bytesUploaded:0,originalFileBytesUploaded:0,totalOriginalFileBytes:0,totalFiles:0,nextFileSize:0};if(r)this.refreshStats();p(this._flashStats).forEach(function(t){if(t){s.elapsedTime+=t.elapsedTime;s.filesUploaded+=t.filesUploaded;s.filesFailed+=t.filesFailed;s.bytesUploaded+=t.bytesUploaded;s.originalFileBytesUploaded+=t.originalFileBytesUploaded;s.totalOriginalFileBytes+=t.totalOriginalFileBytes;s.totalFiles+=t.totalFiles;s.nextFileSize+=t.nextFileSize;}});s.estimatedTotalTime=s.elapsedTime*s.totalOriginalFileBytes/s.originalFileBytesUploaded;s.estimatedTimeToComplete=s.estimatedTotalTime-s.elapsedTime;s.percentCompleted=s.originalFileBytesUploaded/s.totalOriginalFileBytes*100;s.nextPercentTarget=(s.originalFileBytesUploaded+s.nextFileSize)/s.totalOriginalFileBytes*100;s.estimatedTimeToNextTarget=s.elapsedTime*s.nextFileSize/s.originalFileBytesUploaded;if(s.originalFileBytesUploaded===0){s.estimatedTimeToNextTarget=null;s.estimatedTotalTime=null;s.estimatedTimeToComplete=null;}return s;},uploadImages:function(){if(!this.getImagesSelected())return false;if(this._uploading)return true;for(var r=0;r<this._flashIDs.length;r++){var s=this._flashStats[this._flashIDs[r]];if(s&&s.totalFiles>(s.filesUploaded+s.filesFailed)){var t=this._flash(r);if(typeof t.uploadClick!=='function')continue;(function(u,v){this._flashStats[v]=u.uploadClick();}).bind(this,t,this._flashIDs[r]).defer();i.sendSignal({qn:this._waterfall_id,step:i.UPLOAD_START,uploader:this._uploaderName,count:this.getImagesSelected()});this._uploading=true;return true;}}return false;},getRoot:function(){return m(this._flashIDs[0]);},copyWidth:function(r,s){s=s||this._flashIDs[0];var t=m(s).style;t.width=r.offsetWidth+'px';t.height=r.offsetHeight+'px';},setHiRes:function(r){this._flashIDs.forEach(function(s,t){var u=this._flash(t);if(typeof u.setHiResUpload!=='function')return;var v=u.setHiResUpload(r);this._flashStats[s]=v;if(v&&v.filesUploaded<v.totalFiles)this._uploading=true;}.bind(this));},testFlashUpload:function(){this._flash().testUploader();},testSelectFilesByUrl:function(r,s,t){return this._flash(t).testSelectFilesByUrl(r,s);},getRecognitionTimeEstimate:function(){return this._recognitionConfig.pollPeriod*this._recognitionConfig.pollAttempts;},startRecognition:function(){new h().setURI(this._recognitionConfig.url).setData({uid:this._recognitionConfig.owner,aid:this._recognitionConfig.aid,phase:1}).send();this._recognitionPolls=0;this._recognitionTimeout=window.setTimeout(this.checkRecognitionProgress.bind(this),this._recognitionConfig.pollPeriod);},cancelUpload:function(){this._uploading=false;this._stopHeartbeat=true;this._flashIDs.forEach(function(r,s){(r in this._heartbeats)&&this._heartbeats[r].timer&&clearInterval(this._heartbeats[r].timer);}.bind(this));this._callAllSWFs(true,'cancelUpload');},checkRecognitionProgress:function(){var r=this._recognitionConfig.pollPeriod;if(++this._recognitionPolls>=this._recognitionConfig.pollAttempts){this.recognitionFinished();return;}new h().setURI(this._recognitionConfig.url).setData({uid:this._recognitionConfig.owner,aid:this._recognitionConfig.aid,phase:2}).setHandler(function(s){var t=s.getPayload();if(!t||t.done){this.recognitionFinished();}else this._recognitionTimeout=window.setTimeout(this.checkRecognitionProgress.bind(this),r);}.bind(this)).setErrorHandler(function(s){this._recognitionTimeout=window.setTimeout(this.checkRecognitionProgress.bind(this),r);}.bind(this)).send();}});e.exports=q;});
__d("FlashUploader",["Arbiter","AsyncRequest","$","Dialog","DOM","copyProperties","Run","curry","FlashUploadController","PhotosUploadWaterfall","UploadEvent","goURI","tx"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('$'),j=b('Dialog'),k=b('DOM'),l=b('copyProperties'),m=b('Run'),n=b('curry'),o=b('FlashUploadController'),p=b('PhotosUploadWaterfall'),q=b('UploadEvent'),r=b('goURI'),s=b('tx'),t=function(){};t.instances={};l(t.prototype,{init:function(u,v,w,x){this.copyConfig(x);this._flashID=w;this._selectButton=u;this._instanceId=v;t.instances[this._instanceId]=this;this._controller=new o(w,x,this.onFlashLoadError.bind(this),this.onFlashUpgradeRequired.bind(this),this.onFlashUpgradeSuggested.bind(this));m.onLeave(function(){t.instances={};this.destroy();}.bind(this));m.onBeforeUnload(this.handleBeforeUnload.bind(this));m.onUnload(this.handleUnload.bind(this));this.initArbiter();this.parsePhotoSetToken();},onFlashLoadError:function(u){},onFlashUpgradeRequired:function(u){},onFlashUpgradeSuggested:function(){},initArbiter:function(){[q.DONE,q.ERROR,q.FINISHED_UPLOADING,q.LOADED,q.READY,q.UPLOAD_FAILED,q.UPLOAD_PROGRESS,q.HI_RES_ATTACH_START,q.IMAGE_UPLOAD_ERROR,q.IMAGE_UPLOADED,q.IMAGES_SELECTED,q.SELECT_CANCELED,q.SELECT_DOWN,q.SELECT_OUT,q.SELECT_OVER,q.SELECT_UP].forEach(this._subscribe.bind(this));},copyConfig:function(u){this.checkConfig(u);for(var v in u)this['_'+v]=u[v];l(this,{_closeOnComplete:true,_dialog:null,_fbx:false,_hiResDone:false,_isBound:false,_locationSessionID:0,_locationTypeahead:null,_recognitionStarted:false,_showDoneOnComplete:false,_standardDone:false,_subscriptions:[]});},checkConfig:function(u){},destroy:function(){while(this._subscriptions.length)g.unsubscribe(this._subscriptions.pop());this._controller.destroy();},_subscribe:function(u){this._subscriptions.push(g.subscribe(u,this.arbiterFilter.bind(this)));},setAid:function(u){this._aid=u;this._controller.setAid(u);},getAid:function(u){return this._aid;},logDeadProgressBar:function(){p.sendSignal({qn:this._qn,uploader:this._uploaderName,step:p.PROGRESS_BAR_STOPPED,meta:this._controller.getStats(true)});},setUseSpecialAlbum:function(u){this.setAid('0');this._controller.addPostParam('album_type',u);if(this._targetId)this._controller.addPostParam('target_id',this._targetId);return this;},setPhotoSetToken:function(u){this._photoSetToken=u;this._controller.addPostParam('set_token',u);return this;},getPhotoSetToken:function(){return this._photoSetToken;},parsePhotoSetToken:function(){if(!this._photoSetToken)return;var u=this._photoSetToken.split('.');if(this._created||(u[0]&&!u[1])){this._createNewSet=true;this._closeOnComplete=false;}},getUploadQueryData:function(u){var v={instance_id:this._instanceId,id:this._owner,'new':u};if(this._aid)v.aid=this._aid;if(this._targetId)v.target=this._targetId;if(this._photoSetToken)v.set=this._photoSetToken;return v;},arbiterFilter:function(u,v){},cancelUpload:function(){this._controller.cancelUpload();this._canceled=true;p.sendSignal({qn:this._qn,uploader:this._uploaderName,step:p.CANCEL,meta:{method:'add-more-cancel'}});},cancelNewAlbumOrSet:function(){this._canceled=true;k.remove(i(this._flashID));p.sendSignal({qn:this._qn,uploader:this._uploaderName,step:p.CANCEL,meta:{method:'new-album-cancel'}});var u;if(this._createNewSet){u=new h().setURI('/ajax/photos/sets/delete/').setData({set:this._photoSetToken,id:this._owner});}else u=new h().setURI('/ajax/photos/album/delete/').setData({aid:this._aid,id:this._owner});var v=n(r,window.location.href,true);if(this._surveyVisible){new h('/photos/upload/survey_flag/').setMethod('POST').send();v=function(){new j().setAsync(new h('/survey/surveyDialog').setData({survey_id:'216629141722067'})).setCancelHandler(n(r,window.location.href,true)).show();};}u.setHandler(v).send();},getErrorMessage:function(u){switch(u.failureCode){case 0:return s._("We're having trouble uploading {filename}. Make sure you are connected to the internet",{filename:u.filename});case 1:return null;case 2:return s._("We couldn't open {filename}. Make sure it has not been deleted from your computer.",{filename:u.filename});case 3:return s._("We could not understand the contents of {filename}.  Make sure it is a jpg, gif, or png formatted image.",{filename:u.filename});case 4:return s._("{filename} is too large. Please resize your photo to under\n                     8000x8000 pixels and try again.",{filename:u.filename});}return null;},handleUnload:function(){if(this._controller.isUploading()&&!this._canceled)p.sendSignal({qn:this._qn,uploader:this._uploaderName,step:p.CANCEL,meta:{method:'nav-away'}});},handleBeforeUnload:function(){if(this._controller.isUploading()&&!this._canceled)return "If you leave this page now your photos will not be uploaded.";},allDone:function(){},setHiRes:function(u){this._fbx=u;this._controller.setHiRes(this._fbx);},getHiRes:function(){return this._fbx;}});e.exports=t;});
__d("FlashUploaderOverlay",["event-extensions","Arbiter","AsyncRequest","Button","Class","CSS","Dialog","DocumentTitle","DOM","Flash","FlashUploader","Form","Keys","Layer","Parent","PhotosUploadWaterfall","Style","Tooltip","UploadEvent","URI","UserAgent","Vector","PhotoTagStore","Run","$","copyProperties","curry","goURI","isEmpty","tx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Button'),j=b('Class'),k=b('CSS'),l=b('Dialog'),m=b('DocumentTitle'),n=b('DOM'),o=b('Flash'),p=b('FlashUploader'),q=b('Form'),r=b('Keys'),s=b('Layer'),t=b('Parent'),u=b('PhotosUploadWaterfall'),v=b('Style'),w=b('Tooltip'),x=b('UploadEvent'),y=b('URI'),z=b('UserAgent'),aa=b('Vector'),ba=b('PhotoTagStore'),ca=b('Run'),da=b('$'),ea=b('copyProperties'),fa=b('curry'),ga=b('goURI'),ha=b('isEmpty'),ia=b('tx');function ja(){this.parent.construct(this);this._photos={};ba.getInstance().clear();ca.onBeforeUnload(function(ka){if(ba.getInstance().hasNewTags())return "You have unsaved tags.";}.bind(this),true);}j.extend(ja,p);ja.bootstrap=function(ka,la,ma,na){var oa=da(la);if(!(ka in p.instances)){(new ja()).init(oa,ka,ma,JSON.parse(da(ma).getAttribute('data-config')));}else p.instances[ka].registerSwf(ma,oa);if(na)h.bootstrap(oa.getAttribute('ajaxify'),oa);};ea(ja.prototype,{MAX_FACE_POLLS:5,BASE_FACE_POLL_TIMEOUT:500,init:function(ka,la,ma,na){this._originalDocumentTitle=m.get();this._selectButtons={};this._selectButtons[ma]=ka;this._fallbackHref=na.fallbackHref;this._pendingAid=null;this._backdatedTime=null;this._showConfirmAlbumDelete=false;this._hideFromNewsfeed=null;this.parent.init(ka,la,ma,na);if(na.logDetailed)u.sendSignal({qn:this._qn,step:u.VERSION,uploader:na.uploaderName,version:o.getVersion().join('.')});},onFlashLoadError:function(ka){if(!this._fallbackHref)return;for(var la in this._selectButtons){var ma=this._selectButtons[la],na=y(this._fallbackHref).addQueryData({error:ka}).toString();ma.removeAttribute('rel');ma.removeAttribute('ajaxify');ma.setAttribute('href',na);this.enableButton(ma);}},onFlashUpgradeRequired:function(ka){this.onFlashLoadError(ka);},onFlashUpgradeSuggested:function(){},registerSwf:function(ka,la){this._selectButtons[ka]=la;this._controller.registerSwf(ka);},arbiterFilter:function(ka,la){if(!this._controller.isEventIntendedForMe(la))return;switch(ka){case x.READY:return this.handleReady(la);case x.SELECT_OVER:return k.addClass(this._selectButton,'selectOver');case x.SELECT_OUT:return k.removeClass(this._selectButton,'selectOver');case x.IMAGES_SELECTED:return this.handleImagesSelected(la);case x.ERROR:return this.handleError(la.response);case x.HI_RES_ATTACH_START:return this.handleHiResAttachStart(la);case x.UPLOAD_PROGRESS:return this.handleImageUploaded(la);case x.DONE:return this.done();}},handleReady:function(ka){var la=this._selectButtons[ka.divID];this.enableButton(la);this._controller.copyWidth(la,ka.divID);if(this._pendingAid)this.parent.setAid(this._pendingAid);},setAid:function(ka){this.parent.setAid(ka);this._pendingAid=ka;},enableButton:function(ka){var la=t.byClass(ka,'addPhotosDisabled');if(la){k.removeClass(la,'addPhotosDisabled');k.addClass(la,'addPhotosEnabled');}},showAlbumLimitExceededDialog:function(){new l().setModal(false).setTitle("Upload Error").setBody("This album is full. If you'd like to upload more pictures, please create a new album.").setButtons(l.CLOSE).setModal(true).show();},handleImagesSelected:function(ka){if(this._editor){if(ka.maxReached)this.showAlbumLimitExceededDialog();if(ka.count===0)return;this.addPlaceholders(ka.count);this.updateOverallProgress();this.startUpload();return;}},bindToOverlay:function(ka,la,ma,na,oa){this.setAid(na);this._fbid=oa;this._editor=ka;this._overallProgressBar=la;this._overlay=ma;this._faceRequests={};this._facePollsMade={};this._photosWithUntaggedFaces={};var pa=ma.getRoot();this._progressWrap=n.find(pa,'div.progressWrap');this._footer=n.find(pa,'div.footerBox');this._header=n.find(pa,'div.headerBox');this._overlayPage=n.find(pa,'div.uiLayerPage');this._doneButton=n.find(pa,'.doneButton');var qa=this.repositionFixedElements.bind(this),ra=[Event.listen(n.find(pa,'.cancel'),'click',this.showCancelDialog.bind(this)),Event.listen(this._doneButton,'click',function(){this.updateForm(false);}.bind(this)),Event.listen(document.documentElement,'keydown',function(ua){if(Event.getKeyCode(ua)!==r.ESC)return;this.showCancelDialog();ua.stop();}.bind(this),Event.Priority.URGENT),Event.listen(pa,'scroll',qa),Event.listen(window,'resize',qa)],sa=[g.subscribe('PhotosBulkEditablePhoto.REMOVED',this.handlePhotoDeleted.bind(this)),g.subscribe('PhotoBulkEditTagger.TAG_SAVED',function(ua,va){this._photosWithUntaggedFaces[va.fbid]=false;if(this._faceRequests[va.fbid]){window.clearTimeout(this._faceRequests[va.fbid]);delete this._faceRequests[va.fbid];}}.bind(this),g.SUBSCRIBE_NEW),g.subscribe('PhotosBulkBackdateEditor.SAVED',function(ua,va){if(!n.contains(this._overlayPage,va.context))return;this._backdatedTime=va.backdatedDate;this._hideFromNewsfeed=va.hideFromNewsfeed;}.bind(this))];this._layerSubscription=s.subscribe('hide',function(ua,va){if(this._overlay!==va)return;m.set(this._originalDocumentTitle);ra.forEach(function(wa){wa.remove();});ra=[];sa.forEach(function(wa){wa.unsubscribe();});sa=[];s.unsubscribe(this._layerSubscription);this._layerSubscription=null;}.bind(this));var ta=n.find(this._overlay.getRoot(),'input.fluploader_enable_fbx');this._fbx=ta.checked;Event.listen(ta,'click',function(){this.setHiRes(ta.checked);new h().setURI('/ajax/photos/upload/settings/').setData({resolution:ta.checked?'high':'standard'}).send();}.bind(this));this.addPlaceholders(this._controller.getImagesSelected());this.startUpload();if(this._controller.isAlbumLimitExceeded())this.showAlbumLimitExceededDialog();},addPlaceholders:function(ka){if(ka){k.removeClass(this._overlay.getRoot(),'showEmptyState');}else u.sendSignal({qn:this._qn,step:u.OVERLAY_FIRST,uploader:u.APP_FLASH});if(!this._controller.isUploading())ka--;var la=[],ma=this._editor.getWaitingTemplate().getRoot();for(var na=0;na<ka;na++){var oa=ma.cloneNode(true);k.show(oa);la.push(oa);}n.insertAfter(this._editor.getPlaceholder().getRoot(),la);},startUpload:function(){var ka=this._editor.getPlaceholder();ka.show();this.repositionFixedElements();var la=this._controller.isUploading();if(this._controller.uploadImages()){if(!la)this._editor.getPlaceholder().getProgressBar().setPosition(0).setTarget(95,20000);var ma=this._controller.getStats(),na=ma.nextPercentTarget,oa=ma.estimatedTimeToNextTarget;if(oa===null)oa=20000;this._overallProgressBar.setPosition(this._controller.getPercentComplete()).setCompleteHandler(this.logDeadProgressBar.bind(this)).setTarget(na,oa);this.updateStatusText();this.updateButtonState();}},repositionFixedElements:function(){var ka=aa.getElementPosition(this._overlayPage).y<0;if(ka!=k.hasClass(this._header,'headerFixed'))this.adjustElementPosition(this._header,ka,'headerFixed');var la=aa.getViewportDimensions(),ma=this._editor.getRoot();if(z.firefox()){v.set(ma,'min-height',la.y+'px');if(!k.hasClass(this._footer,'footerFixed'))this.adjustElementPosition(this._footer,true,'footerFixed');return;}var na=aa.getElementPosition(ma).y+aa.getElementDimensions(ma).y+aa.getElementDimensions(this._footer).y,oa=na>la.y;if(oa!=k.hasClass(this._footer,'footerFixed'))this.adjustElementPosition(this._footer,oa,'footerFixed');},adjustElementPosition:function(ka,la,ma){k.conditionClass(ka,ma,la);if(!la){v.set(ka,'marginLeft','');return;}var na=aa.getElementDimensions(ka).x;v.set(ka,'marginLeft',(-Math.round(na/2))+'px');},handleError:function(ka){if(!ka)return;var la=ka.errorSummary,ma=ka.errorDescription,na=this._editor.getPlaceholder().getRoot(),oa=this._editor.getWaitingTemplate().getRoot(),pa=oa.cloneNode(true);n.insertBefore(na,pa);n.appendContent(n.find(pa,'.error .title'),la);n.setContent(n.find(pa,'.error .description'),ma);k.addClass(pa,'editablePhotoErrorPlaceholder');k.show(n.find(pa,'.error'));k.show(pa);var qa=na.nextSibling;if(qa&&k.hasClass(qa,'editablePhoto'))n.remove(qa);this.updatePlaceholder();this.updateOverallProgress();},done:function(){this.updateOverallProgress();this.updateButtonState();},updateHiResStatus:function(ka){if(!this.getHiRes()){k.removeClass(ka.editablePhoto,'editablePhotoNeedsHiRes');return;}var la=n.find(ka.editablePhoto,'.statusBar');if(!ka.hiRes){k.addClass(ka.editablePhoto,'editablePhotoNeedsHiRes');n.setContent(la,"High Resolution: waiting...");return;}window.clearTimeout(ka.hiResTimeout);var ma=500/(100-ka.hiResPercent);ka.hiResTimeout=window.setTimeout(this.updateHiResPercent.bind(this,ka,100,ma,function(){n.setContent(la,"High Resolution:"+' \u2714');k.removeClass.curry(ka.editablePhoto,'editablePhotoNeedsHiRes').defer(2000);}),ma);},handleHiResAttachStart:function(ka){var la=this._photos[ka.response.fbid],ma=ka.stats.estimatedTimeToNextTarget||20000,na=ma/95;la.hiResPercent=1;la.hiResTimeout=window.setTimeout(this.updateHiResPercent.bind(this,la,95,na),na);},updateHiResPercent:function(ka,la,ma,na){var oa=n.find(ka.editablePhoto,'.statusBar');n.setContent(oa,ia._("High Resolution: {percent}\u0025...",{percent:ka.hiResPercent}));if(ka.hiResPercent<la){ka.hiResPercent++;ka.hiResTimeout=window.setTimeout(this.updateHiResPercent.bind(this,ka,la,ma,na),ma);}else if(na)na();},handleImageUploaded:function(ka){var la=ka.response.fbid,ma=this._photos[la];if(ma){ma.hiRes=ka.hiRes;if(ma.hiRes)this.updateHiResStatus(ma);this.updateOverallProgress();return;}ma={fbid:la,hiRes:ka.hiRes};this.fetchEditablePhoto(ma,{});},fetchEditablePhoto:function(ka,la){ea(la,this._editor.needTaggingData()?{need_tagging:true}:{});this._waitingForEditablePhoto=true;new h().setURI(y('/ajax/photos/photo/edit/'+ka.fbid+'/')).setData(la).setHandler(this.handleEditablePhotoReceived.bind(this,ka)).setErrorHandler(function(ma){this._waitingForEditablePhoto=false;delete this._photos[ka.fbid];this.handleError(ma);}.bind(this)).send();},handleEditablePhotoReceived:function(ka,la){var ma=la.getPayload();if(ma.retryIn)return this.fetchEditablePhoto.bind(this,ka,ma).defer(ma.retryIn*1000);this._waitingForEditablePhoto=false;var na=this._editor.getPlaceholder(),oa=na.getProgressBar(),pa=ma,qa=n.insertBefore(na.getRoot(),pa);pa=qa[0];this._registerScaledImageReloader(n.find(pa,'.editablePhotoImage img'));ka.editablePhoto=pa;this._photos[ka.fbid]=ka;this.updateHiResStatus(ka);k.hide(pa);oa.setCompleteHandler(this.showNextEditablePhoto.bind(this,pa)).setTarget(100,500);this.updateOverallProgress();this.pollFaces(ka);},_registerScaledImageReloader:function(ka){var la=1,ma=200,na=Event.listen(ka,'error',function oa(pa){if((la++)<3){window.setTimeout(function(){ka.src=''+ka.src;},ma);ma+=(ma*la);return true;}na.remove();});return true;},pollFaces:function(ka){if(!this._facePollsMade.hasOwnProperty(ka.fbid))this._facePollsMade[ka.fbid]=0;var la=this._facePollsMade[ka.fbid]++;if(la>=this.MAX_FACE_POLLS)return;var ma=this.BASE_FACE_POLL_TIMEOUT*Math.pow(2,la);this._faceRequests[ka.fbid]=window.setTimeout(this.requestFaces.bind(this,ka),ma);},requestFaces:function(ka){var la=n.find(ka.editablePhoto,'div.scaledImage'),ma=aa.getElementDimensions(la);if(!ma.x||!ma.y){this.pollFaces(ka);return;}new h('/ajax/photos/photo/faceboxes/').setData({fbid:ka.fbid,width:ma.x,height:ma.y}).setMethod('GET').setReadOnly(true).setHandler(function(na){if(!na.getPayload()){this.pollFaces(ka);return;}else if(!na.getPayload().html){if(!na.getPayload().detection_done)this.pollFaces(ka);return;}else if(!this._faceRequests[ka.fbid]){this._photosWithUntaggedFaces[ka.fbid]=false;return;}var oa=n.find(ka.editablePhoto,'div.border');n.appendContent(oa,na.getPayload().html);k.addClass.curry(ka.editablePhoto,'showRecognitionBoxes').defer();delete this._faceRequests[ka.fbid];this._photosWithUntaggedFaces[ka.fbid]=true;}.bind(this)).send();},updateStatusText:function(){var ka=this._controller.getStats(),la=this._controller.isUploading(),ma='';if(ka&&ka.estimatedTimeToComplete){var na=Math.ceil(ka.estimatedTimeToComplete/60000);ma=na==1?"one minute remaining":ia._("{time} minutes remaining",{time:na});}else if(la)ma="Estimating remaining time";var oa='';if(la){oa=ia._("{uploaded}\/{total} Uploaded...",{total:this._controller.getImagesSelected(),uploaded:this._controller.getImagesUploaded()});}else oa="Upload Complete";var pa=ma?oa+' \u00b7 '+ma:oa;w.set(this._progressWrap,pa);m.set(oa);},setHiRes:function(ka){if(ka==this.getHiRes())return;this.parent.setHiRes(ka);if(ka){this._overallProgressBar.setPosition(this._controller.getPercentComplete());this.updateButtonState();}this.updateOverallProgress();for(var la in this._photos){var ma=this._photos[la];this.updateHiResStatus(ma);}},updateButtonState:function(){i.setEnabled(this._doneButton,(!this._controller.isUploading()&&!this.inEmptyState()&&this._controller.isRecognitionFinished()));},showNextEditablePhoto:function(ka){var la=this._editor.getPlaceholder().getRoot().nextSibling;if(la&&k.hasClass(la,'editablePhoto'))n.remove(la);k.show(ka);this.updatePlaceholder();this.repositionFixedElements();this.updateOverallProgress();},updatePlaceholder:function(){var ka=this._editor.getPlaceholder(),la=ka.getProgressBar().setCompleteHandler(null).setPosition(0),ma=this._controller,na=ma.getImagesFailed()+ma.getImagesUploaded();if(na>=ma.getImagesSelected()){ka.hide();return;}var oa=Object.keys(this._photos).length+ma.getImagesFailed();if(oa==ma.getImagesSelected()){ka.hide();return;}var pa=ma.getStats().estimatedTimeToNextTarget;if(pa===null)pa=20000;la.setTarget(95,pa);},updateOverallProgress:function(){var ka=this._controller.getStats(),la=this._controller.isUploading();if(la){var ma=ka.estimatedTimeToNextTarget;if(ma===null)ma=20000;if(ma>0)this._overallProgressBar.setTarget(ka.nextPercentTarget,ma).setCompleteHandler(this.logDeadProgressBar.bind(this));this.updateStatusText();}else if(!this._waitingForEditablePhoto)this._overallProgressBar.setCompleteHandler(function(){this._overallProgressBar.setCompleteHandler(null);this.updateStatusText();}.bind(this)).setTarget(100,500);},updateForm:function(ka){var la=true;for(var ma in this._photosWithUntaggedFaces)if(this._photosWithUntaggedFaces[ma]){la=false;break;}var na={id:this._owner,tid:this._targetId,skipClustering:la,qn:this._qn,success:this._controller.getImagesUploaded(),hide_from_newsfeed:this._hideFromNewsfeed,tags:ba.getInstance().getAllTags(),failure:0};if(this._photoSetToken){na.set=this._photoSetToken;}else na.aid=this._aid;if(this._backdatedTime)na.backdated_date=this._backdatedTime;q.createHiddenInputs(na,t.byTag(this._doneButton,'form'));if(!ka)ba.getInstance().clear();if(this._createNewSet)new h().setURI('/ajax/photos/upload/flash/set/finish/').setData({set:this._photoSetToken,target:this._targetId}).setAllowCrossPageTransition(true).send();},handlePhotoDeleted:function(ka,la){this.repositionFixedElements();var ma=la.getPhotoData().fbid;this._controller.markDeleted(ma);delete this._photos[ma];ba.getInstance().removeAllTagsFromPhoto(ma);if(this.inEmptyState()){this.updateButtonState();k.addClass(this._overlay.getRoot(),'showEmptyState');}},inEmptyState:function(){return (ha(this._photos)&&!this._controller.isUploading()&&!this._waitingForEditablePhoto);},cancelAddPhotosToAlbumOrSet:function(){var ka=this._photoSetToken;if(!ka)ka=['a',this._fbid,this._aid,this._owner].join('.');var la=[];for(var ma in this._photos)la.push(ma);new h().setURI('/ajax/photos/multi_delete').setData({set:ka,photo_ids:la}).setHandler(fa(ga,window.location.href,true)).send();},setShowConfirmAlbumDelete:function(){this._showConfirmAlbumDelete=true;},showCancelNewAlbumOrSetDialog:function(){var ka=[l.newButton('delete_album',"Delete Album",'',this.cancelNewAlbumOrSet.bind(this)),l.newButton('keep_album',"Keep Album",'inputaux',this.cancelAddPhotosToAlbumOrSet.bind(this))];new l().setBody("Are you sure you want to delete this album? All photos in the album will be deleted.").setTitle("Delete Album").setButtons(ka).setModal(true).show();},showCancelDialog:function(){var ka="No, Continue Upload",la="Yes, Delete Photos",ma=[l.newButton('delete_photos',la,'',function(){oa.hide();this._overlay.hide();ba.getInstance().clear();this.cancelUpload();if(this._created){if(this._showConfirmAlbumDelete){this.showCancelNewAlbumOrSetDialog();}else this.cancelNewAlbumOrSet();}else this.cancelAddPhotosToAlbumOrSet();}.bind(this)),l.newButton('continue_upload',ka,'inputaux',function(){this.updateForm(true);}.bind(this))],na="You've already uploaded some photos. Do you want to cancel and delete these photos?",oa=new l().setBody(na).setTitle("Cancel upload?").setButtons(ma).setModal(true).show();}});e.exports=ja;});
__d("legacy:FlashUploaderOverlay",["FlashUploader","FlashUploaderOverlay"],function(a,b,c,d){a.FlashUploader=b('FlashUploader');a.FlashUploaderOverlay=b('FlashUploaderOverlay');},3);
__d("PhotoTagApproval",["array-extensions","event-extensions","Arbiter","CSS","copyProperties","DOM","Parent","PhotosConst","ge"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('copyProperties'),j=b('DOM'),k=b('Parent'),l=b('PhotosConst'),m=b('ge');function n(o){this.viewer=o;this.units=[];this.currentUnit=0;var p=o.getVersionConst();if(p==l.VIEWER_SNOWLIFT){this._root=m('fbPhotoSnowliftTagApproval');}else this._root=m('fbPhotoPageTagApproval');g.subscribe(o.getEventString('DATA_CHANGE'),this.restartTagApproval.bind(this));Event.listen(this._root,'click',this.handleClick.bind(this));Event.listen(this._root,'mousemove',function(q){this.hiliteCurrentPendingTag();Event.kill(q);}.bind(this));this.restartTagApproval();}i(n.prototype,{handleClick:function(event){var o=event.getTarget();if(h.hasClass(o,'nextPager')&&h.hasClass(o,'enabled')){this.showNextUnit();}else if(h.hasClass(o,'prevPager')&&h.hasClass(o,'enabled')){this.showPrevUnit();}else if(k.byClass(o,'fbPhotoApprovalPendingButtons')){var p=this.units[this.currentUnit],q=this.getTagNameID(p);if(q){var r=k.byClass(o,'approve');g.inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:q,approve:r,version:this.viewer.getVersionConst()});}this.removeSelectedUnit.bind(this).defer();}return true;},loadUnits:function(o){this.units=j.scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){h.show(this._root);this.showUnit(o);h.conditionClass(this._root,'hidePagers',this.units.length==1);}else{h.hide(this._root);g.inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this.viewer.getVersionConst()});}},restartTagApproval:function(){this.loadUnits(0);},removeSelectedUnit:function(){var o=this.units[this.currentUnit];j.remove(o);this.loadUnits(this.currentUnit);},showNextUnit:function(){this.showUnit(this.currentUnit+1);},showPrevUnit:function(){this.showUnit(this.currentUnit-1);},getTagNameID:function(o){var p=o.id.indexOf(':');return o.id.slice(p+1);},showUnit:function(o){this.units.forEach(h.hide);this.currentUnit=(o+this.units.length)%this.units.length;var p=this.units[this.currentUnit];h.show(p);this.hiliteCurrentPendingTag();h.conditionClass(j.find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);h.conditionClass(j.find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);},hiliteCurrentPendingTag:function(){var o=this.units[this.currentUnit],p=this.getTagNameID(o);g.inform('PhotoTagApproval.HILITE_TAG',{tag:p,version:this.viewer.getVersionConst()});}});e.exports=n;});
__d("legacy:photo-tag-approval",["PhotoTagApproval"],function(a,b,c,d){a.PhotoTagApproval=b('PhotoTagApproval');},3);
__d("legacy:photos-constants",["PhotosConst"],function(a,b,c,d){a.PhotosConst=b('PhotosConst');},3);
__d("Photocrop2",["array-extensions","event-extensions","CSS","DOM","PhotosConst","Vector","Rect","copyProperties"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('PhotosConst'),j=b('Vector'),k=b('Rect'),l=b('copyProperties');function m(o,p,q){this.photo=o;if(q){this.imageDimensions=new j(q.x,q.y);}else this.imageDimensions=new j(o.offsetWidth,o.offsetHeight);l(this,l({target:this.photo.parentNode,width:200,height:200,min_width:i.PIC_NORMAL_FBX_SIZE,min_height:i.PIC_NORMAL_FBX_SIZE,center_x:(this.photo.offsetWidth||200)/2,center_y:(this.photo.offsetHeight||200)/2,square:true},p));this.unscaledMinWidth=this.min_width;this.unscaledMinHeight=this.min_height;if(this.square){this.unscaledMinWidth=Math.min(this.min_width,this.min_height);this.unscaledMinHeight=this.unscaledMinWidth;}this.setNewRatio();this.width=Math.max(this.width,this.min_width);this.height=Math.max(this.height,this.min_height);var r=Math.min(this.width,this.height);if(r>this.photo.offsetWidth||r>this.photo.offsetHeight)r=Math.min(this.photo.offsetWidth,this.photo.offsetHeight);if(this.min_width>this.photo.offsetWidth)this.min_width=this.photo.offsetWidth;if(this.min_height>this.photo.offsetHeight)this.min_height=this.photo.offsetHeight;if(this.square){this.min_width=Math.min(this.min_width,this.min_height);this.min_height=this.min_width;}var s=this.center_x-r/2,t=this.center_y-r/2;this.box=new k(t,s+r,t+r,s);this.displacement=null;g.addClass(this.target,'photocrop');['bg','wrapper','viewport'].forEach(function(u){this[u]=h.create('div');g.addClass(this[u],u);}.bind(this));this.highlight=h.create('img',{src:o.src});g.addClass(this.highlight,'highlight');g.addClass(this.wrapper,'photocropWrapper');this.target.appendChild(this.bg);this.target.appendChild(this.wrapper);this.wrapper.appendChild(this.highlight);this.wrapper.appendChild(this.viewport);['ne','nw','sw','se'].forEach(function(u){var v=h.create('div');g.addClass(v,u);this.viewport.appendChild(v);g.addClass(v,'profilePicViewportGrabby');}.bind(this));Event.listen(this.viewport,{mousedown:this.mousedown.bind(this),dragstart:Event.kill,selectstart:Event.kill,click:Event.stop});Event.listen(document,{mousemove:this.mousemove.bind(this),mouseup:this.mouseup.bind(this)});this.realignToPictureSize();this.redraw();}m.prototype.adjustForResize=function(){var o=this.ratio,p=this.setNewRatio(),q=p/o;this.box.t*=q;this.box.l*=q;this.box.b*=q;this.box.r*=q;this.redraw();this.realignToPictureSize();};m.prototype.setNewRatio=function(){this.ratio=this.photo.offsetWidth/this.imageDimensions.x;this.min_width=this.ratio*this.unscaledMinWidth;this.min_height=this.ratio*this.unscaledMinHeight;return this.ratio;};m.prototype.realignToPictureSize=function(){var o=this.photo;if(!o)return;[this.bg,this.wrapper].forEach(function(p){p.style.width=o.offsetWidth+'px';p.style.height=o.offsetHeight+'px';p.style.top=o.offsetTop+'px';p.style.left=o.offsetLeft+'px';});};var n=function(o,p,q){return Math.max(o,Math.min(q,p));};m.prototype.redraw=function(){var o=[this.box.t,this.box.r,this.box.b,this.box.l];this.highlight.style.width=this.photo.offsetWidth+"px";this.highlight.style.height=this.photo.offsetHeight+"px";this.highlight.style.clip="rect("+o.join("px ")+"px)";this.viewport.style.top=this.box.t+"px";this.viewport.style.left=this.box.l+"px";this.viewport.style.height=(this.box.b-this.box.t)+"px";this.viewport.style.width=(this.box.r-this.box.l)+"px";};m.prototype.done=function(o){this.freezeViewport=true;if(!o){[this.bg,this.wrapper].forEach(h.remove);g.removeClass(this.target,'photocrop');}var p=Math.round(this.box.l*(1/this.ratio)),q=Math.round(this.box.t*(1/this.ratio)),r=Math.round(this.box.r*(1/this.ratio)),s=Math.round(this.box.b*(1/this.ratio));return {x:Math.max(p,0),y:Math.max(q,0),width:r-Math.max(p,0),height:s-Math.max(q,0)};};m.prototype.mousedown=function(o){if(this.freezeViewport)return;this.mouseTarget=o.getTarget();this.pos=j.getEventPosition(o);var p=this.box.r-this.box.l;this.displacement=new j(p,p);g.addClass(document.body,'draggingMode');return false;};m.prototype.mousemove=function(o){if(!this.mouseTarget)return;var p=j.getEventPosition(o).sub(this.pos),q=this.min_width,r=this.min_height,s=this.box,t=this.wrapper.offsetWidth,u=this.wrapper.offsetHeight,v;if(this.mouseTarget===this.viewport){p.x=n(-s.l,p.x,t-s.r);p.y=n(-s.t,p.y,u-s.b);this.box=s.add(p);}else if(g.hasClass(this.mouseTarget,'ne')){if(this.square){this.displacement=this.displacement.add(p.x,-p.y);v=n(q,Math.max(this.displacement.x,this.displacement.y),Math.min(s.b,t-s.l));this.box.r=s.l+v;this.box.t=s.b-v;}else{this.box.r+=p.x=n(s.l+q-s.r,p.x,t-s.r);this.box.t+=p.y=n(-s.t,p.y,s.b-r-s.t);}}else if(g.hasClass(this.mouseTarget,'nw')){if(this.square){this.displacement=this.displacement.add(-p.x,-p.y);v=n(q,Math.max(this.displacement.x,this.displacement.y),Math.min(s.b,s.r));this.box.l=s.r-v;this.box.t=s.b-v;}else{this.box.b+=p.x=n(-s.l,p.x,s.r-q-s.l);this.box.t+=p.y=n(-s.t,p.y,s.b-r-s.t);}}else if(g.hasClass(this.mouseTarget,'se')){if(this.square){this.displacement=this.displacement.add(p.x,p.y);v=n(q,Math.max(this.displacement.x,this.displacement.y),Math.min(u-s.t,t-s.l));this.box.r=s.l+v;this.box.b=s.t+v;}else{this.box.r+=p.x=n(s.l+q-s.r,p.x,t-s.r);this.box.b+=p.y=n(s.t+r-s.b,p.y,u-s.b);}}else if(g.hasClass(this.mouseTarget,'sw'))if(this.square){this.displacement=this.displacement.add(-p.x,p.y);v=n(q,Math.max(this.displacement.x,this.displacement.y),Math.min(u-s.t,s.r));this.box.l=s.r-v;this.box.b=s.t+v;}else{this.box.l+=p.x=n(-s.l,p.x,s.r-q-s.l);this.box.b+=p.y=n(s.t+r-s.b,p.y,u-s.b);}this.redraw();this.pos=this.pos.add(p);return false;};m.prototype.mouseup=function(o){this.mouseTarget=null;g.removeClass(document.body,'draggingMode');};e.exports=m;});
__d("PhotosTaggingWaterfall",["AsyncSignal","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncSignal'),h=b('copyProperties');function i(j){i._queueName=j||i._queueName;}h(i,{BEGIN:"begin",TAG_FACE:"tag_face",HOVER_TAG_FACE:"hover_tag_face",ADD_NAME:"add_name",TAG_CONFIRMED:"tag_confirmed",FINISH:"finish",TYPE_NAME:'type_name',SELECT_NAME:'select_name',_queueName:null,sendSignal:function(j,k){new g('/ajax/photos/tag_waterfall.php',{data:JSON.stringify(j)}).setHandler(k).send();}});e.exports=i;});
__d("PhotoTagger",["event-extensions","array-extensions","function-extensions","Arbiter","AsyncRequest","CSS","DOM","ErrorDialog","Keys","Parent","PhotosConst","PhotosUtils","PhotosTaggingWaterfall","Style","Vector","PhotoTagStore","copyProperties","ge","userAction"],function(a,b,c,d,e,f){b('event-extensions');b('array-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('CSS'),j=b('DOM'),k=b('ErrorDialog'),l=b('Keys'),m=b('Parent'),n=b('PhotosConst'),o=b('PhotosUtils'),p=b('PhotosTaggingWaterfall'),q=b('Style'),r=b('Vector'),s=b('PhotoTagStore'),t=b('copyProperties'),u=b('ge'),v=b('userAction');function w(y,z){return ((y%z)+z)%z;}function x(y,z){this.viewer=y;this.version=y.getVersionConst();this.tagHoverFacebox=z;this.datasources={};this.photoData={};this.tagRects={};this.ajaxURIs={tagsInit:'/ajax/photos/photo/tags/tags_init.php',tagsAlbum:'/ajax/photos/photo/tags/tags_album.php',fetchDatasource:'/ajax/photos/photo/tags/fetch_datasource.php',tagAction:'/ajax/photo_tagging_ajax.php',tagWithAction:'/ajax/with_tagging_ajax.php'};x.instances[this.version]=this;}t(x,{instances:{},getInstance:function(y){return x.instances[y];},resetAlbumTaggingSuggestions:function(y){var z=x.getInstance(y);z&&z.resetAlbumTaggingSuggestions();}});t(x.prototype,{TAG_BOX_SIZE:100,EPSILON:.0025,elemNames:{6:{addTagLink:'div.fbPhotosPhotoOwnerButtons',overlayActions:'div.snowliftOverlayBar'}},initSnowlift:function(y,z,aa){this._init(y,z,aa,this.viewer.container);},initPermalink:function(y,z,aa){this._init(y,z,aa,this.viewer.actionList);},_init:function(y,z,aa,ba){this.setupUserActionLogging();this.root=this.viewer.getRoot();this.tagger=y;this.tokenizer=z;this._qn=null;this.typeahead=z.getTypeahead();this.userId=aa;this.makeProfilePicMenuContainer=ba;this.faceboxes=[];this.currentFacebox=null;this.revokedFaceboxes=[];this.requestFaceboxNextTag=false;this.clickState=j.find(this.root,'div.stageActions');this.newTagBox=j.find(this.clickState,'div.newTagBox');this.addTagLink=j.find(this.root,this.elemNames[this.version].addTagLink);this.overlayActions=j.find(this.root,this.elemNames[this.version].overlayActions);this.setupHandlers();this.hideNewTagTimer=null;this.addedSuggestions=[];this.featuredSuggestions=[];this.albumSuggestions=[];this.friendSuggestions=[];this.suggestionAlbum=-1;this.needAlbumSuggestionsFetch=true;this.fetchTaggingSuggestions({owner:this.photoData.owner});this.setDataSource(this.typeahead.getData());this.updateFaceboxes();this.tagAccumulating=false;return this;},setTagAccumulator:function(y){this.tagAccumulating=y;},setupUserActionLogging:function(){this.ua=v(this.viewer.getSourceString()).uai('init','tagging').add_event('init');},logUserActionEvent:function(y){this.ua.add_event(y);},fetchTaggingSuggestions:function(y){this.logUserActionEvent('sugg_fetch');new h().setURI(this.ajaxURIs.tagsInit).setData(y).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(aa){var ba=aa.getPayload();this.featuredSuggestions=ba.featuredTaggees;this.friendSuggestions=ba.friendTaggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_fetch_done');}.bind(this)).send();var z=this.typeahead.subscribe('bootstrap',function(aa,ba){if(ba&&!ba.bootstrapping){if(this.taggingMode)this.updateWithSuggestions();this.typeahead.unsubscribe(z);this.typeahead.subscribe('focus',function(){if(this.taggingMode)this.updateWithSuggestions();}.bind(this));this.typeahead.subscribe('click',function(){if(!this.taggingMode)this.updateWithSuggestions();}.bind(this));this.tokenizer.subscribe('removeToken',this.updateWithSuggestions.bind(this));this.tokenizer.subscribe('addToken',this.addSuggestion.bind(this));this.typeahead.subscribe('respond',function(ca,da){if(this.taggingMode&&da&&!da.results.length)this.updateWithSuggestions();}.bind(this));}}.bind(this));},fetchAlbumTaggingSuggestions:function(){this.logUserActionEvent('sugg_album_fetch');new h().setURI(this.ajaxURIs.tagsAlbum).setData({cachedAlbum:this.suggestionAlbum,photo:this.photoData.fbid}).setOption('retries',1).setAllowCrossPageTransition(true).setHandler(function(y){this.needAlbumSuggestionsFetch=false;var z=y.getPayload();if(z.length===0)return;this.suggestionAlbum=z.album;this.albumSuggestions=z.taggees;this.updateTypeaheadSuggestions();this.logUserActionEvent('sugg_album_fetch_done');}.bind(this)).send();},resetAlbumTaggingSuggestions:function(){this.needAlbumSuggestionsFetch=true;this.updateTypeaheadSuggestions();},updateTypeaheadSuggestions:function(){this.typeahead.getView().setSuggestions(this.addedSuggestions.concat(this.featuredSuggestions,this.needAlbumSuggestionsFetch?[]:this.albumSuggestions,this.friendSuggestions));},setupHandlers:function(){this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(window,'resize',this.hideTagger.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];Event.listen(document.documentElement,'keydown',function(event){if(!this.taggingMode)return;var y=Event.getKeyCode(event);if(y===l.ESC){this.deactivateTagging();}else if(y===l.TAB)this.addNextTagFromFacebox(event.shiftKey?-1:1);}.bind(this));this.subscriptions=[g.subscribe(this.viewer.getEventString('PAGE'),this.restartTagging.bind(this)),g.subscribe(this.viewer.getEventString('DATA_CHANGE'),this.setPhotoData.bind(this)),g.subscribe(this.viewer.getEventString('EXTRA_DATA_CHANGE'),this.setExtraData.bind(this)),g.subscribe(this.viewer.getEventString('CLOSE'),this.deactivateTagging.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},updateWithSuggestions:function(y,z){var aa=this.typeahead.getData().buildUids(' ',this.typeahead.getView().getSuggestions(),this.typeahead.getCore().getExclusions());if(!aa.length)return;var ba=this.typeahead.getData().respond('',aa);for(var ca=0;ca<ba.length;ca++)ba[ca].index=-1000+ca;},addSuggestion:function(y,z){var aa=z.info&&z.info.uid;if(aa){this.addedSuggestions.unshift(aa);this.updateTypeaheadSuggestions();}},setQueueName:function(y){this._qn=y;return this;},_sendWaterfallLogSignal:function(y){p.sendSignal({qn:this._qn,source:this.viewer.getSourceString(),step:y,pid:this.photoData.pid});},_bumpQueueName:function(){if(this._qn)this._qn+=1;},activateTagging:function(){this.logUserActionEvent('activate');g.inform('PhotoTagger.ACTIVATE_TAGGING');if(this.getDataSource()){this.dataSourceFetched(this.getDataSource());}else new h(this.ajaxURIs.fetchDatasource).setData({fbid:this.photoData.fbid,version:this.version}).send();if(this.needAlbumSuggestionsFetch)this.fetchAlbumTaggingSuggestions();},restartTagging:function(){this.hideNewTag();this.hideTagger();this.revokedFaceboxes=[];this.setCurrentFacebox(null);if(this.taggingMode){this.requestFaceboxNextTag=true;this.activateTagging();}},getDataSource:function(){return this.datasources[this.getDataSourceKey()];},getDataSourceKey:function(){if(this.photoData.ownertype=='user'&&!this.photoData.obj_id)return 'friends';return this.photoData.obj_id||this.photoData.owner;},setDataSource:function(y){if(this.typeahead.getData()!=y)this.typeahead.swapData(y);this.datasources[this.getDataSourceKey()]=y;},dataSourceFetched:function(y){this.taggingMode=true;i.addClass(this.root,'taggingMode');g.inform('PhotoTagger.ACTIVATED_TAGGING');this._bumpQueueName();this._sendWaterfallLogSignal(p.BEGIN);this.setDataSource(y);},deactivateTagging:function(){this.logUserActionEvent('deactivate');if(this.taggingMode===true)this._sendWaterfallLogSignal(p.FINISH);this.taggingMode=false;this.hideNewTag();this.hideTagger();this.setCurrentFacebox(null);i.removeClass(this.root,'taggingMode');g.inform('PhotoTagger.DEACTIVATED_TAGGING');},checkActions:function(event){var y=event.getTarget();if(m.byClass(y,'fbPhotosPhotoActionsTag'))if(this.taggingMode){this.deactivateTagging();}else{this.activateTagging();this.addNextTagFromFacebox(1);}},hideTagger:function(){i.hide(this.tagger);j.find(this.tagger,'input.textInput').blur();},showTagger:function(){i.show(this.tagger);(function(){j.find(this.tagger,'input.textInput').focus();}).bind(this).defer();this.hideNewTag();},showNewTag:function(y){if(!this.newTagBox)return;j.setContent(j.find(this.newTagBox,'div.tagName'),j.create('span',null,y));i.show(this.newTagBox);this.hideNewTagTimer=setTimeout(this.hideNewTag.bind(this),3000);},hideNewTag:function(){if(!this.newTagBox)return;if(this.hideNewTagTimer!==null){clearTimeout(this.hideNewTagTimer);this.hideNewTagTimer=null;}i.hide(this.newTagBox);},getTaggerPositioningOrigin:function(){return r.getElementPosition(this.clickState,'document');},addTag:function(event){var y=event.getTarget(),z=m.byClass(y,'fbPhotosPhotoButtons');if(!this.taggingMode||(z&&y!==z)||m.byClass(y,'fbPhotosPhotoActions')||m.byClass(y,'photoTagTypeahead'))return;var aa=this.viewer.getImage(),ba=r.getEventPosition(event),ca=o.absoluteToNormalizedPosition(aa,ba);this.setCurrentFacebox(this.findNearestFacebox(ca));if(this.currentFacebox){this.addTagFromFacebox(this.currentFacebox);}else{i.removeClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');this.addTagFromPosition(ba,this.TAG_BOX_SIZE);}},findNearestFacebox:function(y){var z=Infinity,aa=null;this.faceboxes.forEach(function(ba){if(ba.rect.contains(y)){var ca=y.distanceTo(ba.rect.getCenter());if(ca<z){z=ca;aa=ba;}}});return aa;},addNextTagFromFacebox:function(y){if(this.faceboxes.length===0)return;if(!this.currentFacebox){this.setCurrentFacebox(this.faceboxes[0]);}else{var z=this.faceboxes.indexOf(this.currentFacebox),aa=w(z+y,this.faceboxes.length);if(aa===z)return;this.setCurrentFacebox(this.faceboxes[aa]);}this.addTagFromFacebox(this.currentFacebox);},addTagFromFacebox:function(y){i.addClass(y.node,'active');i.addClass(j.find(this.tagger,'.faceBox'),'faceBoxHidden');var z=y.rect.getCenter(),aa=this.viewer.getImage(),ba=o.normalizedToAbsolutePosition(aa,z),ca=(y.rect.w()/100)*r.getElementDimensions(aa).x;this.addTagFromPosition(ba,ca);},addTagFromPosition:function(y,z){var aa=this.viewer.getImage(),ba=this.calcTaggerPosition(aa,y,z);this.calcClickPoint(aa,y);if(!ba){this.hideTagger();return;}ba.setElementPosition(this.tagger);if(this.newTagBox){ba.setElementPosition(this.newTagBox);new r(z,z).setElementDimensions(this.newTagBox);}this.showTagger();if(this.taggingMode){this._sendWaterfallLogSignal(p.TAG_FACE);}else this._sendWaterfallLogSignal(p.HOVER_TAG_FACE);},calcTaggerPosition:function(y,z,aa){var ba=r.getElementPosition(y),ca=r.getElementDimensions(y),da=new r(aa/2,aa/2),ea=z.sub(ba);for(var fa in {x:1,y:1}){if(z[fa]<ba[fa]||z[fa]>ba[fa]+ca[fa])return null;if(ea[fa]<(aa/2)){da[fa]=ea[fa];}else if(ca[fa]<ea[fa]+(aa/2))da[fa]=aa-(ca[fa]-ea[fa]);}var ga=3,ha=j.find(this.tagger,'.faceBox');q.set(ha,'width',(aa-ga*2)+'px');q.set(ha,'height',(aa-ga*2)+'px');var ia=z.sub(this.getTaggerPositioningOrigin());return ia.sub(da.x,da.y);},calcClickPoint:function(y,z){var aa=r.getElementDimensions(y),ba=r.getElementPosition(y),ca=z.sub(ba);this.clickPoint={x:ca.x/aa.x,y:ca.y/aa.y};},saveTag:function(y,z){var aa=this.getTaggingData('add',z.isFreeform()?'':z.getValue(),z.getText());aa.x=this.clickPoint.x*100;aa.y=this.clickPoint.y*100;aa.from_facebox=!!this.currentFacebox;aa.tagging_mode=!!this.taggingMode;this.logUserActionEvent('save');if(this.tagAccumulating){s.getInstance().storeTagWithOptions(this.photoData.fbid,aa.subject,aa.x,aa.y,aa);}else new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(aa).setAllowCrossPageTransition(true).setHandler(this.tagsChangeHandler.bind(this)).setErrorHandler(this.checkError.bind(this,z)).send();if(this.userId===parseInt(aa.subject,10)){var ba=j.scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(ba.length===1){var ca=ba[0];i.removeClass(ca,'hide');}}this.showNewTag(z.getText());this.hideTagger();var da=this.currentFacebox;if(da){if(this.taggingMode)this.addNextTagFromFacebox(1);this.removeFacebox(da);}},getTaggingData:function(y,z,aa){return {cs_ver:this.version,pid:this.photoData.pid,fbid:this.photoData.fbid,id:this.photoData.owner,subject:z,name:aa,action:y,source:this.viewer.getSourceString(),qn:this._qn,position:this.getPosition()};},getPosition:function(){return this.viewer.getPosition();},tagsChangeHandler:function(y){this.logUserActionEvent('save_done');},checkError:function(y,z){if(z.getPayload()&&z.getPayload().clear_tag){y.already_untagged=true;this.tokenizer.removeToken(y);}k.showAsyncError(z);},removeTag:function(y,z,aa){if(z.already_untagged)return;var ba='remove';if(j.scry(z.element,'a.pending')[0])ba='retract';if(z.blockUser)ba='remove_block';this.logUserActionEvent('save');if(this.tagAccumulating){if(z.isFreeform()){s.getInstance().removeTextTag(this.photoData.fbid,z.getInfo().text);}else s.getInstance().removeTag(this.photoData.fbid,z.getInfo().uid);}else new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData(ba,z.isFreeform()?'':z.getInfo().uid,z.getInfo().text)).setHandler(function(ea){this.tagsChangeHandler(ea);aa&&aa();}.bind(this)).setAllowCrossPageTransition(true).send();if(this.userId===parseInt(z.getValue(),10)&&this.userId!==this.viewer.getCurrentPhotoInfo().owner){var ca=j.scry(this.makeProfilePicMenuContainer,'[data-picid="'+this.viewer.getCurrentPhotoInfo().fbid+'"]');if(ca.length===1){var da=ca[0];i.addClass(da,'hide');}g.inform('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION');}},removeTagByID:function(y,z,aa){var ba=this.tokenizer.tokens;for(var ca=0;ca<ba.length;ca++)if(ba[ca].info.uid==z)return this.removeTag(null,ba[ca],aa);},removeTagByIDFromHovercardLink:function(y,z,aa){this.removeTagByID(y,z,function(){if(window.Hovercard)window.Hovercard.contains(aa)&&window.Hovercard.hide(true);});},removeWithTag:function(y,z){new h().setURI(this.ajaxURIs.tagWithAction).setMethod('POST').setData({action:'remove_with',taggee:z,tag:y,version:this.version,fbid:this.photoData.fbid}).setHandler(function(aa){this.tagsChangeHandler(aa);if(window.Hovercard)window.Hovercard.hide(true);}.bind(this)).setAllowCrossPageTransition(true).send();},setPhotoData:function(y,z){this.photoData=z;return this;},setExtraData:function(y,z){this.tagRects=z.tagRects;this.updateFaceboxes();return this;},markTagAsSpam:function(y,z){new h().setURI(this.ajaxURIs.tagAction).setMethod('POST').setData(this.getTaggingData('mark_as_spam',z,null)).send();},removeFacebox:function(y){if(y===null)return;this.revokedFaceboxes.push(y.rect.getCenter());this.faceboxes.remove(y);j.remove(y.node);if(y===this.currentFacebox)this.setCurrentFacebox(null);},setCurrentFacebox:function(y){if(this.currentFacebox)i.removeClass(this.currentFacebox.node,'active');this.currentFacebox=y;},updateRevokedFaceboxes:function(){this.revokedFaceboxes=this.revokedFaceboxes.filter(function(y){for(var z=0;z<this.faceboxes.length;++z){var aa=this.faceboxes[z],ba=y.distanceTo(aa.rect.getCenter());if(ba<this.EPSILON)return true;}return false;}.bind(this));this.revokedFaceboxes.forEach(function(y){var z=this.findNearestFacebox(y);this.faceboxes.remove(z);j.remove(z.node);}.bind(this));},updateFaceboxes:function(){if(this.version!==n.VIEWER_SNOWLIFT)return;this.faceboxes=[];for(var y in this.tagRects)if(o.isFacebox(y))this.faceboxes.push({node:u(y),id:y,rect:this.tagRects[y]});this.updateRevokedFaceboxes();this.faceboxes.sort(function(aa,ba){return aa.rect.getCenter().x-ba.rect.getCenter().x;});if(this.currentFacebox){var z=this.currentFacebox.rect.getCenter();this.setCurrentFacebox(this.findNearestFacebox(z));i.addClass(this.currentFacebox.node,'active');}if(this.requestFaceboxNextTag){this.addNextTagFromFacebox(1);this.requestFaceboxNextTag=false;}},getFacebox:function(y){for(var z=0;z<this.faceboxes.length;++z)if(this.faceboxes[z].id===y)return this.faceboxes[z];return null;}});e.exports=x;});
__d("legacy:PhotoTagger",["PhotoTagger"],function(a,b,c,d){a.PhotoTagger=b('PhotoTagger');},3);
__d("PhotoPermalink",["array-extensions","event-extensions","function-extensions","Arbiter","AsyncRequest","Bootloader","Class","CSS","DOM","KeyEventController","Keys","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoStreamCache","PhotosUtils","PhotoViewer","Style","UserAgent","Vector","$","copyProperties","createArrayFrom","emptyFunction","ge","goURI"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('Bootloader'),j=b('Class'),k=b('CSS'),l=b('DOM'),m=b('KeyEventController'),n=b('Keys'),o=b('PageTransitions'),p=b('Parent'),q=b('PhotosConst'),r=b('PhotoSessionLog'),s=b('PhotoStreamCache'),t=b('PhotosUtils'),u=b('PhotoViewer'),v=b('Style'),w=b('UserAgent'),x=b('Vector'),y=b('$'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('emptyFunction'),ca=b('ge'),da=b('goURI');function ea(){this.parent.construct(this);this.encodingMode=false;this._uriStack=[];this.replaceUrl=false;}z(ea,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,_instance:null,getInstance:function(){if(!ea._instance)ea._instance=new ea();return ea._instance;},addPhotoFbids:function(fa,ga,ha){ea.getInstance().addPhotoFbids(fa,ga,ha);},attachTagger:function(fa){ea.getInstance().attachTagger(fa);},init:function(){ea.getInstance().init();},recacheData:function(fa){ea.getInstance().recacheData(fa);},saveTagsFromPayload:function(fa){ea.getInstance().saveTagsFromPayload(fa);},saveTagsFromPayloadDelayed:function(fa){ea.saveTagsFromPayload.curry(fa).defer(2000);},handleServerError:function(fa,ga){ea.getInstance().handleServerError(fa,ga);},setHasLocation:function(fa){ea.getInstance().setHasLocation(fa);},storeFromData:function(fa){ea.getInstance().storeFromData(fa);},swapData:function(){ea.getInstance().swapData();},touchMarkup:ba,updateTotalCount:function(fa,ga,ha){ea.getInstance().updateTotalCount(fa,ga,ha);},isInVideoEncodingMode:function(){return ea.getInstance().isInVideoEncodingMode();},disableAutoRefresh:function(){ea.getInstance().disableAutoRefresh();},enableAutoRefresh:function(fa){ea.getInstance().enableAutoRefresh(fa);}});j.extend(ea,u);z(ea.prototype,{init:function(){this.stream=new s();this.stream.init(q.VIEWER_PERMALINK,'PhotoViewerPagelet');this.reset();this.root=y('fbPhotoPageContainer');this.header=y('fbPhotoPageHeader');this.stageWrapper=ca('photoborder');this.videoStage=l.find(this.stageWrapper,'div.videoStage');this.buttonActions=l.find(this.root,'div.stageButtons');this.feedback=ca('fbPhotoPageFeedback');this.image=ca('fbPhotoImage');this.errorBox=ca('fbPhotoPageError');this.actionList=ca('fbPhotoPageActions');this.stageActions=l.find(this.root,'div.stageActions');this.loadingStates={image:false,html:false};this.unhiliteTimer=null;this.pageHandlers=[Event.listen(this.root,'mouseout',this.mouseOutListener.bind(this)),Event.listen(this.root,'mousemove',this.mouseMoveListener.bind(this)),Event.listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),Event.listen(this.stageWrapper,'dragstart',this.killDrag.bind(this)),Event.listen(this.stageWrapper,'selectstart',this.killDrag.bind(this)),Event.listen(this.buttonActions,'click',this.buttonListener.bind(this)),Event.listen(this.actionList,'click',this.rotateListener.bind(this)),Event.listen(this.feedback,'click',function(event){if(p.byClass(event.getTarget(),'like_link'))k.toggleClass(l.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this))];o.registerHandler(this.transitionHandler.bind(this));m.registerKey('LEFT',this.goNav.bind(this));m.registerKey('RIGHT',this.goNav.bind(this));r.initLogging(r.PERMALINK);g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));},getEventPrefix:function(){return 'PhotoPermalink';},getSourceString:function(){return 'permalink';},getVersionConst:function(){return q.VIEWER_PERMALINK;},saveTagsFromPayload:function(fa){this.storeFromData(fa);if('data' in fa&&this.stream.getCursor() in fa.data)this.swapData();},goNav:function(event){var fa=Event.getKeyCode(event)||event.getTarget(),ga=event.type==='click'&&p.byClass(fa,'stageWrapper')&&!p.byClass(fa,'tagBoxPending')&&!p.byClass(fa,'tagBoxPendingResponse');if(ga&&k.hasClass(this.root,'taggingMode'))return false;if(fa==n.LEFT){this.page(-1);}else if(fa==n.RIGHT||ga)this.page(1);return false;},pagerClick:function(fa){if(fa=='prev'){this.page(-1);}else if(fa=='next')this.page(1);return false;},setLoadingState:function(fa,ga){switch(fa){case ea.STATE_IMAGE_DATA:this.loadingStates[fa]=ga;k.conditionClass(this.root,'imageLoading',ga);break;case ea.STATE_HTML:this.loadingStates[fa]=ga;k.conditionClass(this.root,'dataLoading',ga);break;}},checkState:function(fa){if(fa!=ea.STATE_ERROR&&!this.loadingStates[fa])return;switch(fa){case ea.STATE_IMAGE_DATA:var ga=this.stream.getCurrentImageData();if(ga){if(ga.url){this.switchImage(ga.url,true);}else if(ga.video)this.switchVideo(ga.video,true);this.setLoadingState(fa,false);}break;case ea.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(fa,false);}break;default:if(this.stream.errorInCurrent()){k.hide(this.image);k.show(this.errorBox);}break;}},reHilitePendingTag:function(){var fa=ca(this.hilitedTag);if(fa&&k.hasClass(fa,'showPendingTagName'))return;var ga=l.scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(ga)this.switchHilitedTags(ga.id);},isPagingAllowed:function(fa){return this.stream.isValidMovement(fa)&&!k.hasClass(this.root,'croppingMode');},page:function(fa,ga){if(!this.isPagingAllowed(fa))return;this.unhiliteAllTags();var ha=this.getVideoOnStage();if(ha)this.switchVideo(ha,false);this.recacheData();this.stream.moveCursor(fa);k.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(ea.STATE_HTML,true);k.show(this.errorBox);return;}var ia=this.stream.getCurrentImageData();if(ia){if(ia.url){this.switchImage(ia.url,true);}else if(ia.video)this.switchVideo(ia.video,true);if(!ga){this.replaceUrl=true;da(ia.info.permalink);}}else{this.waitForLoadCount++;this.setLoadingState(ea.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(ea.STATE_HTML,true);g.inform('PhotoPermalink.PAGE');},transitionHandler:function(fa){if(fa.getPath()!=='/photo.php')return false;if(fa.getQueryData().makeprofile&&fa.getQueryData().fbid==this.stream.getCursor()&&!this.getVideoOnStage()){i.loadModules(['PhotoCropper'],function(ja){ja.start();});o.transitionComplete();return true;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(fa.getQualifiedURI().toString());o.transitionComplete();return true;}var ga=this._uriStack.length;if(ga>=2&&this._uriStack[ga-2]==fa.getQualifiedURI().toString())this._uriStack.pop();var ha=this.stream.getCursorForURI(fa.getUnqualifiedURI().toString());if(ha){var ia=this.stream.getRelativeMovement(ha);this.page(ia,true);o.transitionComplete();return true;}return false;},recacheData:function(fa){if(!this.loadingStates.html){var ga=this.stream.getCurrentHtml();for(var ha in ga){ga[ha]=aa(y(ha).childNodes);if(fa!==true&&ha!=='fbPhotoPageHeader')l.empty(y(ha));}}},getCurrentPhotoInfo:function(){var fa=this.stream.getCurrentImageData();return fa&&fa.info;},getVideoOnStage:function(){var fa=this.stream.getCurrentImageData();return fa&&fa.video;},switchImage:function(fa,ga){k.hide(this.image);k.hide(this.errorBox);var ha=this.stream&&this.stream.getCurrentImageData();if(ha)r.addPhotoView(ha.info);var ia=l.create('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:fa});l.replace(this.image,ia);this.image=ia;if(ga)this.stream.preloadImages();},switchVideo:function(fa,ga){var ha='swf_'+fa;if(ga){k.addClass(this.stageWrapper,'showVideo');this.videoStage.id=fa;if(window[ha]&&!ca(ha))window[ha].write(fa);}else{this.videoStage.id='fbPageVideoStage';window[ha].addVariable('video_autoplay',0);l.empty(this.videoStage);k.removeClass(this.stageWrapper,'showVideo');}},swapData:function(){if(this.dataLoadTimer){this.setLoadingState(ea.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var fa,ga=this.stream.getCurrentHtml();if(ga){for(var ha in ga){fa=ca(ha);fa&&l.setContent(fa,ga[ha]);}g.inform('PhotoPermalink.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoPermalink.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);this.setLoadingState(ea.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();},clearTimer:function(fa){this.dataLoadTimer=false;fa&&this.swapData();},adjustForNewData:function(){if(!this.image)return;var fa=l.scry(this.stageWrapper,'div.tagsWrapper')[0],ga=x.getElementDimensions(this.image);if(fa){v.set(fa,'width',ga.x+'px');v.set(fa,'height',ga.y+'px');if(w.ie()<=7){var ha=l.scry(this.root,'div.tagContainer')[0];if(ha)k.conditionClass(fa,'ie7VerticalFix',x.getElementDimensions(ha).y>ga.y);}}},fetchInitBucket:function(fa){if(!this.stream.isLoaded())return;this.stream.fetch(fa,true);},addPhotoFbids:function(fa,ga,ha){var ia=this.stream.getCursor()===null;this.stream.attachToFbidsList(fa,ga,ha);if(ha&&ia)this.page(0);},attachTagger:function(fa){l.appendContent(this.stageActions,fa);},storeFromData:function(fa){var ga=this.stream.storeToCache(fa);if('init' in fa){r.setPhotoSet(this.stream.getPhotoSet());r.setLogFbids(true);r.addPhotoView(this.stream.getCurrentImageData().info);}if('error' in ga){this.checkState(ea.STATE_ERROR);return;}if('image' in ga)this.checkState(ea.STATE_IMAGE_DATA);if('data' in ga)this.checkState(ea.STATE_HTML);},handleServerError:function(fa,ga){l.setContent(this.errorBox,fa);this.storeFromData(ga);},updateTotalCount:function(fa,ga,ha){var ia=ca('fbPhotoPagePositionAndCount');ia&&l.setContent(ia,ha);this.stream.setTotalCount(fa);this.stream.setFirstCursorIndex(ga);},buttonListener:function(event){var fa=event.getTarget();if(p.byClass(fa,'likeButton')){var ga=l.scry(this.feedback,'button.like_link')[0];if(!ga){ga=l.scry(this.feedback,'a.UFILikeLink')[0];k.toggleClass(l.find(fa,'^div.likeCommentGroup'),'viewerLikesThis');}ga&&ga.click();}else if(p.byClass(fa,'commentButton')){var ha=l.scry(this.feedback,'div.commentBox textarea')[0];if(!ha)ha=l.scry(this.feedback,'li.UFIAddComment textarea')[0];if(ha){ha.focus();this.root.scrollTop=this.root.scrollHeight;}}},rotateListener:function(event){var fa=event.getTarget();if(p.byClass(fa,'rotateRight')){this.rotate('right');}else if(p.byClass(fa,'rotateLeft'))this.rotate('left');},stageClickListener:function(event){var fa=event.getTarget();if(p.byClass(fa,'fbPhotoTagApprovalBox')||p.byClass(fa,'videoStage')||p.byClass(fa,'tag')){return true;}else if(p.byClass(fa,'fbPhotoViewLarger')){i.loadModules(['PhotoSnowlift'],function(ga){ga.bootstrap(window.location,fa);});}else this.goNav(event);},rotate:function(fa){var ga=this.stream.getCursor();if(this.getVideoOnStage()){var ha=(fa=='left')?270:90;i.loadModules(['VideoRotate'],function(ja){new ja(ga,this.actionList).motionRotate(ha);}.bind(this));return;}var ia=z({fbid:ga,cs_ver:q.VIEWER_PERMALINK},this.stream.getPhotoSetQuery());ia[fa]=1;this.setLoadingState(ea.STATE_IMAGE_DATA,true);k.hide(this.image);new h('/ajax/photos/photo/rotate/').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(ia).setFinallyHandler(this.rotateComplete.bind(this,ga)).send();},rotateComplete:function(fa,ga){if(fa==this.stream.getCursor()){this.setLoadingState(ea.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}},mouseOutListener:function(event){var fa=event.getTarget(),ga=event.getRelatedTarget(),ha=p.byClass(fa,'stageActions'),ia=p.byClass(fa,'stageWrapper'),ja=p.byClass(ga,'stageActions'),ka=p.byClass(ga,'stageWrapper'),la=(!ka&&(ia&&!ja)||(ha&&!ka));if(la)this.unhiliteAllTags(true);},mouseMoveListener:function(event){var fa=event.getTarget();if(!p.byClass(fa,'stageActions')&&!p.byClass(fa,'stageWrapper'))return;this.hiliteTagsOnMouseMove(event);},unhiliteAllTags:function(fa,event){l.scry(this.stageWrapper,'div.tagsWrapper div.hover').forEach(function(ga){if(fa&&k.hasClass(ga,'tagBoxPending'))return;k.removeClass(ga,'hover');});if(fa)return;if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;},switchHilitedTags:function(fa,ga){this.unhiliteAllTags();var ha=ca(fa);if(ha){this.hilitedTag=fa;k.addClass(ha,'hover');if(k.hasClass(ha,'tagBoxPending')&&!k.hasClass(ha,'showPendingTagName')&&ga===true){l.scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').forEach(function(ia){k.removeClass(ia,'showPendingTagName');});k.addClass(ha,'showPendingTagName');}}},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var fa=event.getTarget();if(p.byClass(fa,'fbPhotoPageTagApproval')||p.byClass(fa,'tagPointer'))return;var ga=p.byClass(fa,'tagBoxPending'),ha=(this.hilitedTag&&k.hasClass(y(this.hilitedTag),'tagBoxPending')),ia=((!this.hilitedTag&&ga)||(!ha&&ga));if(ia){this.switchHilitedTags(ga.id);return;}if(ga&&(ga.id==this.hilitedTag))return;var ja=250,ka=t.absoluteToNormalizedPosition(this.image,x.getEventPosition(event)),la=t.getNearestBox(this.stream.getCurrentExtraData().tagRects,ka);if(!la){if(!ha){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var ma=null;if(ha){var na={};na[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];ma=t.getNearestBox(na,ka);}if(ma!==null&&ha)return;if(this.hilitedTag!=la)if(ha){this.unhiliteTimer=this.unhiliteAllTags.bind(this,false,event).defer(ja);}else this.switchHilitedTags(la);},updateTagBox:function(fa,ga){this.unhiliteAllTags();var ha=ca(fa);if(!ha)return;k.addClass(ha,'tagBox');k.addClass(ha,'tagBoxPendingResponse');k.removeClass(ha,'tagBoxPending');k.hide(l.find(ha,'span.tagForm'));if(ga){k.show(l.find(ha,'span.tagApproved'));}else k.show(l.find(ha,'span.tagIgnored'));},killDrag:function(){if(k.hasClass(this.root,'taggingMode'))return false;},reset:function(){while(this.pageHandlers&&this.pageHandlers.length)this.pageHandlers.pop().remove();m.getInstance().resetHandlers();},onHiliteTag:function(fa,ga){if(ga.version!=q.VIEWER_PERMALINK)return;var ha=ga.tag;if(ha){this.switchHilitedTags(ha,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(fa,ga){if(ga.version==q.VIEWER_PERMALINK)this.updateTagBox(ga.id,ga.approve);},disableAutoRefresh:function(){clearTimeout(this.timerId);},isInVideoEncodingMode:function(){return this.encodingMode;},enableAutoRefresh:function(fa){this.encodingMode=true;this.timerId=window.location.reload.bind(window.location).defer(fa);},setHasLocation:function(fa){k.conditionClass(this.root,'hasLocation',fa);}});e.exports=ea;});
__d("legacy:fb-photos-permalink-js",["PhotoPermalink"],function(a,b,c,d){a.PhotoPermalink=b('PhotoPermalink');},3);
function PhotoPermalinkTagger(a){this.parent.construct(this,PhotoPermalink.getInstance());this.photoData=a;}Class.extend(PhotoPermalinkTagger,'PhotoTagger');copyProperties(PhotoPermalinkTagger.prototype,{elemNames:{0:{addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons'}},setupHandlers:function(){var a=$('imagestage'),b=$('fbPhotoPageTagBoxes');this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(a,'click',this.addTag.bind(this)),Event.listen(b,'click',this.addTag.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];this.subscriptions=[Arbiter.subscribe('PhotoPermalink.PAGE',this.restartTagging.bind(this)),Arbiter.subscribe('PhotoPermalink.DATA_CHANGE',this.setPhotoData.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},setDataForTokenizer:function(){this.tokenizer.setup(null,this.photoData);return this;}});
__d("PhotoCropper",["event-extensions","function-extensions","Arbiter","CSS","DOM","Form","Dialog","Keys","tx","Photocrop2","PhotoPermalink","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('Form'),k=b('Dialog'),l=b('Keys'),m=b('tx'),n=b('Photocrop2'),o=b('PhotoPermalink'),p=b('copyProperties'),q={initialize:function(r){this.clickHandlers=[];if(this.photocrop)this.destroy(false);this.photoPermalink=o.getInstance();this.root=this.photoPermalink.getRoot();this.options=r||{};this.registerClickHandler();this.registerEscapeKeyHandler();g.subscribe('PhotoPermalink.PAGE',function(){this.registerClickHandler();this.registerEscapeKeyHandler();this.destroy(false);}.bind(this),g.SUBSCRIBE_NEW);g.subscribe('PhotoTagger.REMOVED_MAKE_PROFILE_PIC_OPTION',this.destroy.bind(this,false));},registerEscapeKeyHandler:function(){Event.listen(document.documentElement,'keydown',function(event){if(Event.getKeyCode(event)===l.ESC)this.destroy(false);}.bind(this));},registerClickHandler:function(){this.actionLinks=i.find(this.root,'div.fbPhotosPhotoActions');var r=i.scry(this.actionLinks,'a.fbPhotoActionsCrop');if(r.length===0)return;var s=i.find(r[0],'.startCropping');if(this.clickHandlers.indexOf(s)!==-1)return;Event.listen(s,'click',function(){this.start();return false;}.bind(this));this.clickHandlers.push(s);},start:function(){if(this.photocrop)return;this.cropLink=i.find(this.actionLinks,'a.fbPhotoActionsCrop');if(h.hasClass(this.cropLink,'profileAlbum')){new k().setTitle("Make Profile Picture").setBody("You've used this photo as your profile picture before. Do you want to use it again?").setButtons([k.CONFIRM,k.CANCEL]).setModal(true).setHandler(function(){this.reuseProfilePic.bind(this).defer();return false;}.bind(this)).setCancelHandler(function(){this.cancelAndStopEvent();}.bind(this)).show();return false;}h.addClass(this.cropLink,'croppingModeOn');h.addClass(this.root,'croppingMode');var r=i.find(this.root,'img.fbPhotoImage'),s=i.find(this.root,'a.doneCroppingLink'),t=i.find(this.root,'a.cancelCroppingLink'),u=i.find(this.cropLink,'.doneCropping');this.wrapper=i.create('div');h.addClass(this.wrapper,'stageCropper');i.find(this.root,'.stageWrapper').appendChild(this.wrapper);this.wrapper.style.marginTop=r.parentNode.style.marginTop;Event.listen(this.wrapper,'click',function(event){Event.kill(event);});Event.listen(s,'click',this.done.bind(this));Event.listen(t,'click',this.cancelAndStopEvent.bind(this));Event.listen(u,'click',this.done.bind(this));var v={target:this.wrapper,min_width:this.options.min_width},w=(function(){this.photocrop=new n(r,v);}).bind(this);if(r.complete){w();}else Event.listen(r,'load',w);return false;},done:function(){var r=o.getInstance().getCurrentPhotoInfo(),s=this.getProfilePicTarget(r).id,t=this.destroy(true);if(!t)return false;var u=p({fbid:r.fbid,owner:r.owner,id:s,'return':'profile.php?id='+s,error_return:'photo.php?pid='+r.pid+'&id='+r.owner},t);j.post('/crop_profile_pic.php',u);return false;},cancelAndStopEvent:function(){this.destroy(false);return false;},destroy:function(r){if(!this.photocrop){if(!r&&this.wrapper){i.remove(this.wrapper);this.wrapper=null;}return null;}h.removeClass(this.cropLink,'croppingModeOn');h.removeClass(this.root,'croppingMode');if(r){h.addClass(this.root,'profilePicSavingMode');}else{i.remove(this.wrapper);this.wrapper=null;}var s=this.photocrop.done(r);this.photocrop=null;return s;},reuseProfilePic:function(){var r=o.getInstance().getCurrentPhotoInfo(),s=this.getProfilePicTarget(r),t=p({pid:r.pid,owner:r.owner,id:s.id,type:s.type,profile_pic_id:s.id});j.post('/pic_upload.php',t);return false;},getProfilePicTarget:function(r){if(h.hasClass(this.cropLink,'makePageProfile'))return {id:r.owner,type:'object'};return {id:this.options.uid,type:'profile'};}};e.exports=q;});
__d("PhotoTags",["array-extensions","event-extensions","Arbiter","CSS","DOM","Parent","PhotosConst","copyProperties","cx","ge"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('DOM'),j=b('Parent'),k=b('PhotosConst'),l=b('copyProperties'),m=b('cx'),n=b('ge');function o(p,q,r){this.tagTargets=p;this.tagBox=q;this.version=r||k.VIEWER_PERMALINK;this.handlers=[];this.tagTargets.forEach(function(s){this.handlers.push(Event.listen(s,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==k.VIEWER_SNOWLIFT)this.subscriptions.push(g.subscribe("PhotoSnowlift.PAGE",this.hideTags.bind(this)));}l(o.prototype,{showTag:function(event){var p=event.getTarget(),q=h.hasClass(p,'taggee'),r=h.hasClass(p,"_rx"),s=null;if(q){s=p.getAttribute('data-tag');}else if(r){var t=j.byTag(p,'a');s=t&&t.getAttribute('data-tag');}var u=this.version==k.VIEWER_PERMALINK?'perm:tag:'+s:'tag:'+s,v=u&&n(u);if(v){h.addClass(v,'showTag');h.addClass(this.tagBox,'showingTag');}},hideTags:function(){h.removeClass(this.tagBox,'showingTag');i.scry(this.tagBox,'div.showTag').forEach(function(p){h.removeClass(p,'showTag');});},destroy:function(){for(var p in this.handlers)this.handlers[p].remove();this.subscriptions.forEach(g.unsubscribe.bind(g));}});e.exports=o;});
__d("legacy:PhotoTags",["PhotoTags"],function(a,b,c,d){a.PhotoTags=b('PhotoTags');},3);
__d("TagToken",["Class","DOM","Token","copyProperties"],function(a,b,c,d,e,f){var g=b('Class'),h=b('DOM'),i=b('Token'),j=b('copyProperties');function k(l){this.parent.construct(this,l,'tag');}g.extend(k,i);j(k.prototype,{createElement:function(){var l=this.isFreeform(),m=h.create('span',{className:'separator'},', '),n=h.create(l?'span':'a',{className:'taggee','data-tag':this.getValue()},this.getText());if(!l)n.href=this.getInfo().path;return h.create('span',{className:'tagItem'},[m,n]);}});e.exports=k;});
__d("TagTokenizer",["Arbiter","Bootloader","Class","CSS","DOM","Input","Parent","PhotosConst","TagToken","Tokenizer","copyProperties","createObjectFrom","ge","tx"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Bootloader'),i=b('Class'),j=b('CSS'),k=b('DOM'),l=b('Input'),m=b('Parent'),n=b('PhotosConst'),o=b('TagToken'),p=b('Tokenizer'),q=b('copyProperties'),r=b('createObjectFrom'),s=b('ge'),t=b('tx');function u(v,w,x,y){this.parent.construct(this,x,y);g.subscribe('PhotoInlineEditor.CANCEL_INLINE_EDITING',this.updateTokenareaVisibility.bind(this),g.SUBSCRIBE_NEW);this.appphoto=w;if(v.getInstance().getVersionConst()===n.VIEWER_VAULTBOX){v.subscribe('data',this.setup.bind(this),g.SUBSCRIBE_NEW);}else g.subscribe(v.getInstance().getEventString('DATA_CHANGE'),this.setup.bind(this),g.SUBSCRIBE_NEW);}i.extend(u,p);q(u.prototype,{setup:function(v,w){this.appphoto=w.byapp;this.byowner=w.isowner;return this.reset();},reset:function(){var v=this.getTokenElements().map(this.getTokenDataFromTag.bind(this));this.withTagKeys={};var w=this.getWithTagTokenElements().map(function(x){return this._tokenKey(this.getTokenDataFromTag(x));}.bind(this));this.withTagKeys=r(w);return this.parent.reset(v);},processEvents:function(event,v,w){if(m.byClass(v,'remove')){var x=this.getTokenFromElement(w);x=this.addTokenData(x,v);this.removeToken(x);event.kill();}},insertToken:function(v){return null;},removeToken:function(v){if(this.appphoto){return this.replaceToken(v);}else{this.inform('removeToken',v);g.inform('Form/change',{node:this.element});}},addTokenData:function(v,w){if(m.byClass(w,'blockuser'))v.blockUser=true;return v;},getTokenDataFromTag:function(v){return {uid:k.find(v,'input').value,text:k.getText(k.find(v,'.taggee'))};},getTokenElementFromTarget:function(v){return m.byClass(v,'tagItem');},getTokenElements:function(){return k.scry(this.tokenarea,'span.tagItem').filter(this.filterNonTokenElements.bind(this));},getWithTagTokenElements:function(){return k.scry(this.tokenarea,'span.withTagItem');},filterNonTokenElements:function(v){return !j.hasClass(v,'markasspam')&&!j.hasClass(v,'reported')&&!j.hasClass(v,'withTagItem');},createToken:function(v,w){var x=this.getToken(this._tokenKey(v));x=x||new o(v);w&&x.setElement(w);return x;},updateTokenareaVisibility:function(){var v=this.getTokenElements().filter(function(x){return j.shown(x);}),w=this.getWithTagTokenElements();j.conditionShow(this.tokenarea,v.length!==0||w.length!==0);},replaceToken:function(v){if(!v)return;var w=this.tokens.indexOf(v);if(w<0)return;this.tokens.splice(this.tokens.indexOf(v),1);delete this.unique[this._tokenKey(v.getInfo())];var x=s('tagspam'+v.getValue());x&&k.remove(x);var y=[' [',"Tag Removed.",' '];y.push(k.create('a',{onclick:this.markAsSpam.bind(this,v.getValue())},"Mark tag as spam"));y.push('] ');var z=k.create('span',{className:'fbPhotosTaglistTag tagItem markasspam',id:'tagspam'+v.getValue()},y);k.replace(v.getElement(),z);this.updateTokenarea();this.inform('removeToken',v);g.inform('Form/change',{node:this.element});},markAsSpam:function(v){var w=s('tagspam'+v),x=[' [',"Tag Reported",'] '],y=k.create('span',{className:'fbPhotosTaglistTag tagItem reported',id:'tagspam'+v},x);k.replace(w,y);this.inform('markTagAsSpam',v);}});e.exports=u;});
__d("TagTypeaheadView",["Class","TypeaheadView","copyProperties"],function(a,b,c,d,e,f){var g=b('Class'),h=b('TypeaheadView'),i=b('copyProperties');function j(k,l){this.parent.construct(this,k,l);this.hintText=l.hintText;this.userEd=l.userEd;this.origAutoSelect=l.autoSelect;this.setSuggestions(l.suggestions);}g.extend(j,h);i(j.prototype,{buildResults:function(k){if(!this.value)k.unshift({subtext:this.hintText,type:'hintText'});if(this.userEd)k.unshift({subtext:this.userEd,type:'userEdText'});var l=this.parent.buildResults(k);if(this.userEd)k.shift();if(!this.value)k.shift();return l;},render:function(k,l,m){this.autoSelect=this.origAutoSelect&&k.length;this.disableAutoSelect=k.length===0;this.parent.render(k,l,m);},getItems:function(){var k=this.parent.getItems();if(!this.value)k.shift();if(this.userEd)k.shift();return k;},getSuggestions:function(){return this.suggestions;},setSuggestions:function(k){this.suggestions=k||[];this.visible=!!this.suggestions;},addSuggestion:function(k){this.suggestions.unshift(k);}});e.exports=j;});
__d("TypeaheadHintText",["copyProperties","emptyFunction"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('emptyFunction');function i(j){this._typeahead=j;}g(i.prototype,{enable:function(){this._typeahead.getCore().resetOnKeyup=false;},disable:h});e.exports=i;});
__d("legacy:HintTextTypeaheadBehavior",["TypeaheadHintText"],function(a,b,c,d){var e=b('TypeaheadHintText');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.hintText=function(f){f.enableBehavior(e);};},3);
__d("PortfolioTour",["event-extensions","AsyncRequest","CSS","DOM","Parent","Style","copyProperties","csx"],function(a,b,c,d,e,f){b('event-extensions');var g=b('AsyncRequest'),h=b('CSS'),i=b('DOM'),j=b('Parent'),k=b('Style'),l=b('copyProperties'),m=b('csx'),n=null;function o(p,q,r,s){this._root=p.getRoot();this._dialog=p;this._closeLink=q;this._carousel=r;this._init();}l(o.prototype,{_init:function(){o.markSeen();this._prevButton=i.find(this._root,"._30_");this._nextButton=i.find(this._root,"._310");this._doneButton=i.find(this._root,"._311");Event.listen(this._closeLink,'click',this._onCloseClick.bind(this));Event.listen(this._doneButton,'click',o.hideHeader);this._carousel.subscribe('page_start',this._onPage.bind(this));this._dialog.subscribe(['button','cancel'],this._onButtonClick.bind(this));},_onButtonClick:function(p,q){if(p==='button')if(q===this._prevButton){this._carousel.page('prev');}else if(q===this._nextButton)this._carousel.page('next');},_onCloseClick:function(event){this._dialog.hide();o.hideHeader();},_onPage:function(p,q){var r;if(q===this._carousel.getNumItems()-1){r=[true,false,true];}else if(q===0){r=[false,true,false];}else r=[true,true,false];this._updateButtonState(r);},_updateButtonState:function(p){h.conditionShow(this._prevButton,p[0]);h.conditionShow(this._nextButton,p[1]);h.conditionShow(this._doneButton,p[2]);}});l(o,{setup:function(p,q){n=p;Event.listen(q,'click',function(){o.markSeen();o.hideHeader();});},markSeen:function(){new g().setURI('/ajax/photos/portfolio/seen_tour.php').setMethod('POST').send();},hideHeader:function(){var p=j.byClass(n,'.fbPortfolioTourVisible');if(p)h.removeClass(p,'fbPortfolioTourVisible');k.set(n,'height',0);}});e.exports=o;});
__d("PhotoInlineCaptionEditor",["event-extensions","CSS","DOM","DOMControl","Input","Parent","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('DOMControl'),j=b('Input'),k=b('Parent'),l=b('copyProperties'),m=function(n){this.instanceId=n;m.instances[n]=this;};l(m,{instances:{},getInstance:function(n){return this.instances[n];}});l(m.prototype,{init:function(n){this.element=n;Event.listen(n,'click',this.handleClick.bind(this));var o=h.scry(n,'input[name="caption_id"]');if(o.length)o[0].value=this.instanceId;this.inputStr='';var p=h.scry(this.element,'textarea.fbPhotoCaptionInput')[0];if(p)this.inputStr=j.getValue(p);},handleClick:function(event){var n=event.getTarget();if(k.byClass(n,'editIcon')||k.byClass(n,'noCaption')){this.toggleEditDescription(true);}else if(k.byClass(n,'cancelEdit')){j.setValue(h.find(this.element,'textarea.fbPhotoCaptionInput'),this.inputStr);this.toggleEditDescription(false);}},setCaption:function(n){h.setContent(h.find(this.element,'.fbPhotoCaptionText'),n);this.toggleEditDescription(false);this.inputStr=j.getValue(h.find(this.element,'textarea.fbPhotoCaptionInput'));},getCaption:function(){return h.getText(h.find(this.element,'.fbPhotoCaptionText'));},toggleEditDescription:function(n){if(!n)h.find(this.element,'textarea.fbPhotoCaptionInput').blur();g.conditionClass(this.element,'fbPhotoInlineCaptionEditorEditMode',!!n);if(n){var o=h.find(this.element,'textarea.fbPhotoCaptionInput'),p=i.getInstance(o);p&&p.update();o.focus();}else{g.conditionClass(h.find(this.element,'.noCaption'),'hidden_elem',this.getCaption().length);g.conditionClass(h.find(this.element,'.withCaption'),'hidden_elem',!this.getCaption().length);}}});e.exports=m;});
__d("legacy:PhotoInlineCaptionEditor",["PhotoInlineCaptionEditor"],function(a,b,c,d){a.PhotoInlineCaptionEditor=b('PhotoInlineCaptionEditor');},3);
__d("StarGridReorder",["array-extensions","event-extensions","Arbiter","AsyncRequest","CSS","DOM","Locale","SimpleDrag","StarGrid","StarGridLayout","Style","Vector"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('CSS'),j=b('DOM'),k=b('Locale'),l=b('SimpleDrag'),m=b('StarGrid'),n=b('StarGridLayout'),o=b('Style'),p=b('Vector'),q=15,r={getOrder:function(s){return s.map(function(t){return t.getAttribute('data-id');});},addDragListener:function(s,t){var u=new n({isStarred:m.isStarred,renderNonStarred:m.renderNonStarred,renderStarred:m.renderStarred,isFixed:m.isFixed}),v=k.isRTL()?'margin-right':'margin-left',w,x,y=u.canonicalize(m.getElements(s)),z,aa;function ba(ca){var da=new l(ca);da.setMinDragDistance(q);var ea=false,fa=j.scry(ca,'a[rel="theater"]');fa.forEach(function(ga){Event.listen(ga,'click',function(event){if(ea)event.kill();});});da.subscribe('mousedown',function(ga,event){ea=false;x=p.getEventPosition(event);w=x.sub(new p(o.get(ca,v),o.get(ca,'margin-top')));});da.subscribe('start',function(){ea=true;if(aa)i.removeClass(aa,'fbPhotoStarGridAbove');i.addClass(ca,'fbPhotoStarGridDrag');i.addClass(ca,'fbPhotoStarGridAbove');aa=ca;});da.subscribe('update',function(ga,event){var ha=p.getEventPosition(event);if(k.isRTL())ha.x=2*x.x-ha.x;ha=ha.sub(w);z=u.reorder(y,ca,Math.floor((ha.x+m.getSize(s)/2)/m.getSize(s)),Math.floor((ha.y+m.getSize(s)/2)/m.getSize(s)));m.layoutGrid(s,z);o.set(ca,'margin-top',ha.y+'px');o.set(ca,v,ha.x+'px');});da.subscribe('end',function(ga,event){i.removeClass(ca,'fbPhotoStarGridDrag');m.layoutGrid(s,z);new h(t).setData({order:r.getOrder(z)}).setErrorHandler(function(ha){y=ha;m.layoutGrid(s,z);}.bind(this,y)).send();y=z;});}y.forEach(ba);g.subscribe('StarGrid/UPDATE',function(ca,da){da=u.canonicalize(da);da.forEach(function(ea){if(y.indexOf(ea)!==-1)ba(ea);});y=da;});}};e.exports=r;});